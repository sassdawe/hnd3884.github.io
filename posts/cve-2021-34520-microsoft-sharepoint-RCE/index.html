<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="CVE-2021-34520 Microsoft Sharepoint RCE" /><meta name="author" content="HoangND" /><meta property="og:locale" content="en" /><meta name="description" content="Phân tích lỗi CVE-2021-34520" /><meta property="og:description" content="Phân tích lỗi CVE-2021-34520" /><link rel="canonical" href="https://hnd3884.github.io/posts/cve-2021-34520-microsoft-sharepoint-RCE/" /><meta property="og:url" content="https://hnd3884.github.io/posts/cve-2021-34520-microsoft-sharepoint-RCE/" /><meta property="og:site_name" content="HoangND" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-09-04T10:36:00+07:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="CVE-2021-34520 Microsoft Sharepoint RCE" /><meta name="twitter:site" content="@svcrps38" /><meta name="twitter:creator" content="@HoangND" /><meta name="google-site-verification" content="TfvZ9qjq-FON4dsURjq-_zTPDu1wLUj3bMCMmf-atHU" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"HoangND"},"dateModified":"2022-02-25T01:14:16+07:00","datePublished":"2021-09-04T10:36:00+07:00","description":"Phân tích lỗi CVE-2021-34520","headline":"CVE-2021-34520 Microsoft Sharepoint RCE","mainEntityOfPage":{"@type":"WebPage","@id":"https://hnd3884.github.io/posts/cve-2021-34520-microsoft-sharepoint-RCE/"},"url":"https://hnd3884.github.io/posts/cve-2021-34520-microsoft-sharepoint-RCE/"}</script><title>CVE-2021-34520 Microsoft Sharepoint RCE | HoangND</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="HoangND"><meta name="application-name" content="HoangND"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" /avatar.png " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">HoangND</a></div><div class="site-subtitle font-italic">Intern at Viettel Cyber Security</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/hnd3884" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/svcrps38" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['hoangt2k24','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="https://www.linkedin.com/in/hoang-nguyen-dinh-40b01b155/" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>CVE-2021-34520 Microsoft Sharepoint RCE</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>CVE-2021-34520 Microsoft Sharepoint RCE</h1><div class="post-meta text-muted"><div> By <em> <a href="https://twitter.com/svcrps38">Dinh Hoang</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1630726560" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2021-09-04 </em> </span> <span> Updated <em class="timeago" data-ts="1645726456" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-02-25 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1526 words"> <em>8 min</em> read</span></div></div></div><div class="post-content"><p>Phân tích lỗi CVE-2021-34520</p><h2 id="sharepoint-workflow"><span class="mr-2">Sharepoint Workflow</span><a href="#sharepoint-workflow" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Chúng ta có thể phân tách nghĩa của từ Workflow là làm 2 phần bao gồm “Work” nghĩa là công việc, “flow” nghĩa là dòng chảy. Flow đi chung với Work nghĩa là dòng chảy công việc, luồng công việc hay gọi là quy trình công việc. Workflow được hiểu là một quy trình lặp lại, bao gồm các nhiệm vụ cần phải hoàn thành theo một quy trình cụ thể.</p><p><img data-src="/assets/posts/cve-2021-34520/1.png" alt="image" data-proofer-ignore></p><p>Một workflow bao gồm một hoặc nhiều step, trong mỗi step lại chứa một hay nhiều activity (workflow action).</p><h3 id="trong-sharepoint-có-2-kiểu-workflow"><span class="mr-2">Trong Sharepoint có 2 kiểu workflow</span><a href="#trong-sharepoint-có-2-kiểu-workflow" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><ol><li>Built-in workflow: Đây là các workflow được xây dựng sẵn như template của sharepoint<li>Custom workflow: Sharepoint cho phép xây dựng các workflow theo ý của người dùng. Có hai cách để tạo ra một custom workflow là sử dụng công cụ Sharepoint Designer hoặc tạo từ custom code sử dụng Visual Studio 2012 trở về sau.</ol><h3 id="sử-dụng-workflow-trong-sharepoint"><span class="mr-2">Sử dụng workflow trong sharepoint?</span><a href="#sử-dụng-workflow-trong-sharepoint" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>Trước khi được sử dụng, các workflow sau khi được tạo sẽ được add cho một list, library hoặc content type để khiến nó khả dụng cho các documents hoặc items trong danh sách đấy. Sau đó, các workflow này có thể chạy theo các option như sau</p><ul><li>Chạy thủ công<li>Chạy khi có thay đổi về item (thêm, xóa, sửa thông tin …)</ul><h3 id="workflow-designer"><span class="mr-2">Workflow Designer</span><a href="#workflow-designer" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>SharePoint Designer 2013 là một chương trình thiết kế web và ứng dụng được sử dụng để xây dựng và tùy chỉnh các trang web và ứng dụng trên SharePoint. Sharepoint Designer giúp bạn tạo ra các trang web giàu dữ liệu, xây dựng các workflow mạnh mẽ, hay tạo ra các giao diện đẹp và dễ chịu cho trang web.</p><h2 id="mô-tả-về-lỗi"><span class="mr-2">Mô tả về lỗi</span><a href="#mô-tả-về-lỗi" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p><a href="https://www.zerodayinitiative.com/advisories/ZDI-21-828/">Tài liệu của ZDI</a> mô tả về CVE-2021-34520 như sau:</p><blockquote><p>Lỗ hổng tồn tại trong lớp Microsoft.SharePoint.WorkflowActions.SetVariableActivity. Một thành phần <strong>SetVariableActivity</strong> được tạo thủ công có thể dẫn đến việc khởi tạo một kiểu .NET tùy ý. Attacker có thể lợi dụng lỗ hổng này để thực thi mã từ xa.</p></blockquote><p>SetVariableActivity là một workflow action, vậy khả năng cao lỗ hổng này liên quan đến việc tạo và sử dụng workflow.</p><h2 id="diff-code"><span class="mr-2">Diff code</span><a href="#diff-code" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Cài đặt bản lỗi của Sharepoint Enterprise Server 2016, lỗi tồn tại ở phiên bản sharepoint này cho đến bản patch KB5001946 và được vá ở bản KB5001976. Tiến hành cài đặt hai bản và sử dụng 7zip để gom các file dll cần thiết cho việc diff.</p><p><code class="language-plaintext highlighter-rouge">7z.exe a dll.7z -r .\Microsoft.Sharepoint.*.dll</code></p><p>Tiến hành gom ở 3 thư mục</p><ul><li>C:\Windows\Microsoft.NET\assembly\GAC_MSIL<li>C:\Program Files\Common Files\microsoft shared<li>C:\inetpub\wwwroot\wss</ul><p>Kết quả diff sử dụng WinMerge. Quan sát thấy có sự khác biệt khi có một hàm mới trong bản vá liên quan đến SetVariableActivity tồn tại ở lớp Microsoft.SharePoint.Workflow.SPNoCodeXomlCompiler</p><p><img data-src="/assets/posts/cve-2021-34520/2.png" alt="image" data-proofer-ignore></p><p>Nhìn tên hàm hiểu ngay vấn đề, hàm này dùng để vá lỗi cụ thể là validate thuộc tính ValueType của lớp SetVariableActivity. Hàm này được gọi bên trong hàm IsGoodWorkflow</p><p><img data-src="/assets/posts/cve-2021-34520/3.png" alt="image" data-proofer-ignore></p><p>Hàm IsGoodWorkflow lại được gọi trong hàm CompileBytes</p><p><img data-src="/assets/posts/cve-2021-34520/4.png" alt="image" data-proofer-ignore></p><p>Tiến hành phân tích hàm CompileBytes để xem nó được gọi từ đâu</p><p><img data-src="/assets/posts/cve-2021-34520/5.png" alt="image" data-proofer-ignore></p><p>Sử dụng dnspy, tìm ra được hàm ValidateWorkflowMarkupAndCreateSupportObjects. Theo <a href="https://docs.microsoft.com/en-us/openspecs/sharepoint_protocols/ms-wpps/2d4bd204-cc80-4410-8354-5b675a27c5d6">tài liệu</a> của Microsoft, khi các file workflow được tải lên, nội dung bên trong sẽ đi qua hàm này để validate và biên dịch. Như vậy để có được một kiểu .NET tùy ý ở đây chính là tạo một workflow, bên trong có action SetVariableActivity với giá trị thuộc tính ValueType được tùy chỉnh bởi User.</p><h2 id="tạo-thành-công-một-crafted-setvariableactivity"><span class="mr-2">Tạo thành công một Crafted SetVariableActivity</span><a href="#tạo-thành-công-một-crafted-setvariableactivity" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Sử dụng giao diện trên Workflow Designer, tạo một workflow, thêm một action là Set Workflow Variable vào, như vậy có thể tạo được một SetVariableActivity. Sau khi tạo xong workflow sẽ có hai file được hình thành (Khi publish thì sẽ có thêm một file .xsn hoặc .aspx). Ví dụ ở đây workflow có tên là <em>test</em></p><p><img data-src="/assets/posts/cve-2021-34520/6.png" alt="image" data-proofer-ignore></p><p>File test.xoml là file markup của workflow dùng để biểu diễn các step và action. Còn file test.xoml.wfconfig.xml là file cấu hình của workflow. Ở đây mình dành sự quan tâm cho file test.xoml</p><p><img data-src="/assets/posts/cve-2021-34520/7.png" alt="240272937_934578590739127_77488628058177475_n" data-proofer-ignore></p><p>Ngoài ValueType thì SetVariableActivity có hai thuộc tính khác là Value và Variable. Variable sẽ trỏ đến biến cần được set giá trị, biến này được khai báo ở phần RootWorkflowActivityWithData.WorkflowFields. Value là giá trị để set cho biến này.</p><p>Có thể thấy ngay phần SetVariableActivity đã được tạo, tuy nhiên thuộc tính ValueType vẫn không thể control được hoàn toàn bằng việc sử dụng giao diện. Để hoàn toàn tùy chỉnh ValueType, cần tạo hai file markup và config hợp lệ ở bên ngoài (hai file markup và config có thể copy từ việc tạo 1 flow giả sau đó edit lại) và upload thẳng lên thư mục workflow của Sharepoint Designer, sau đó sử dụng công cụ này publish workflow lên sharepoint site để có thể sử dụng. Theo cách này đã có thể tạo một Crafted SetVariableActivity. Lưu ý rằng không phải thay đổi kiểu gì cũng có thể publish được mà Sharepoint Designer sẽ validate nó hợp lệ xong mới cho phép Publish. Thực nghiệm thấy rằng thay đổi giá trị thuộc tính ValueType vẫn có thể publish được.</p><h2 id="tạo-kiểu-net-nào-cho-rce-"><span class="mr-2">Tạo kiểu .NET nào cho RCE ?</span><a href="#tạo-kiểu-net-nào-cho-rce-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Quan sát lớp Microsoft.SharePoint.WorkflowActions.SetVariableActivity</p><p><img data-src="/assets/posts/cve-2021-34520/8.png" alt="130595758-86fa3659-c515-4c19-a8de-10536f6a9dbd" data-proofer-ignore></p><p>Theo <a href="https://docs.microsoft.com/en-us/dotnet/api/system.workflow.componentmodel.activity.execute?view=netframework-4.8">tài liệu</a> của Microsoft, hàm Execute sẽ được gọi khi chạy activity. Biến type được tạo thành từ thuộc tính ValueType. Hai vị trí khoanh đỏ sẽ là đoạn code tiềm năng để tạo object. Ở khoanh đỏ đầu tiên, sử dụng converter được lấy từ type của obj. Giá trị của biến obj được lấy từ thuộc tính Value và được convert thành type của biến cần thay đổi giá trị.</p><p><img data-src="/assets/posts/cve-2021-34520/9.png" alt="240272937_934578590739127_77488628058177475_n" data-proofer-ignore></p><p>Do type của biến này không thể tùy chỉnh được, vì vậy type của obj bị giới hạn ở các type cơ bản như String, Int32, … và converter của các type này sẽ không thể convert obj thành kiểu ValueType tùy ý được. Do đó suy nghĩ về khoanh đỏ thứ 2. Ở đây sẽ tạo ra một constructor của ValueType nhận một tham số đầu vào dưới dạng String. Qua một số tìm hiểu và các bài PoC được public, tìm ra được một class phù hợp chính là System.Resources.ResourceSet có constructor cần thiết.</p><h6 id="-resourceset-constructor">// ResourceSet Constructor</h6><p><img data-src="/assets/posts/cve-2021-34520/10.png" alt="130601221-3dea4966-a3e9-4b25-8aac-55fed1d1e3ff" data-proofer-ignore></p><p>Constructor này nhận đầu vào là đường dẫn đến file .resource, tạo một ResourceHeader và gọi hàm ReadResource. Quan sát constructor của ResourceHeader</p><h6 id="-resourceheader-constructor">// ResourceHeader Constructor</h6><p><img data-src="/assets/posts/cve-2021-34520/11.png" alt="130640521-6bccfb75-e68a-4957-9299-2aa42afe9873" data-proofer-ignore></p><p>Constructor này đọc file từ đường dẫn fileName lưu vào thuộc tính _store, gọi hàm ReadResource()</p><h6 id="-resourceheaderreadresource">// ResourceHeader.ReadResource()</h6><p><img data-src="/assets/posts/cve-2021-34520/12.png" alt="image" data-proofer-ignore></p><p>Hàm này tạo một BinaryFormatter và lưu vào thuộc tính _objFormatter. Bây giờ quay lại hàm ReadResource của ResourceSet</p><h6 id="-resourcesetreadresource">// ResourceSet.ReadResource()</h6><p><img data-src="/assets/posts/cve-2021-34520/13.png" alt="image" data-proofer-ignore></p><p>Hàm này tạo biến enum từ lớp ResourceEnumerator bên trong lớp ResourceReader <img data-src="/assets/posts/cve-2021-34520/14.png" alt="image" data-proofer-ignore></p><p>Sau đó sử dụng biến này để duyệt và gọi thuộc tính Value để lấy giá trị. Kiểm tra phương thức get của thuộc tính Value bên trong ResourceEnumerator</p><h6 id="-resourceheaderresourceenumeratorvalue">// ResourceHeader.ResourceEnumerator.Value</h6><p><img data-src="/assets/posts/cve-2021-34520/15.png" alt="image" data-proofer-ignore></p><h6 id="-resourceheadergetvaluefornameindex">// ResourceHeader.GetValueForNameIndex()</h6><p><img data-src="/assets/posts/cve-2021-34520/16.png" alt="image" data-proofer-ignore></p><h6 id="-resourceheaderloadobjectv2">// ResourceHeader.LoadObjectV2()</h6><p><img data-src="/assets/posts/cve-2021-34520/17.png" alt="image" data-proofer-ignore></p><h6 id="-resourceheaderdeserializeobject">// ResourceHeader.DeserializeObject()</h6><p><img data-src="/assets/posts/cve-2021-34520/18.png" alt="image" data-proofer-ignore></p><p>Ở đây ResourceHeader sử dụng thuộc tính _objFormatter để deserialize thuộc tính _store. Trong đó _objFormatter là một BinaryFormatter, _store là nội dung bên trong file .resources =&gt; <strong>Lỗi deserialize .NET</strong></p><h2 id="tạo-file-resources-chứa-payload"><span class="mr-2">Tạo file .resources chứa payload</span><a href="#tạo-file-resources-chứa-payload" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Visual studio sử dụng Resource File Generator (Resgen.exe) để convert file .resx thành một binary resource (.resources).</p><p>Tạo file .resx sử dụng chức năng add file của Visual Studio. Để thêm payload vào, chúng ta thêm node data vào trong root trong file .resx như sau</p><p><img data-src="/assets/posts/cve-2021-34520/19.png" alt="image" data-proofer-ignore></p><p>Phần payload được tạo bằng cách sử dụng công cụ ysoserial</p><p><code class="language-plaintext highlighter-rouge">.\ysoserial.exe -o base64 -c "calc" -f BinaryFormatter -g TypeConfuseDelegate</code></p><p>Cuối cùng là dùng resgen để generate ra file .resources</p><p>Sau khi đã đủ lông đủ cánh, thực hiện mô phỏng CVE này.</p><h2 id="proof-of-concept"><span class="mr-2">Proof of Concept</span><a href="#proof-of-concept" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Tạo một site trên sharepoint theo <a href="https://www.youtube.com/watch?v=JQYrqwgpAFY">tutorial</a>. Sau đó tạo một tài khoản attacker. Attacker cần có quyền tạo workflow trên site, điều khiển một máy tính có liên kết với server sharepoint.</p><p>Tạo một file .resources với payload thực hiện command đơn giản là bật calculator (Resource1.resources)</p><p><img data-src="/assets/posts/cve-2021-34520/20.png" alt="image" data-proofer-ignore></p><p>Tạo một SMB server đơn giản theo <a href="http://nikolar.com/2015/03/10/creating-network-share-with-anonymous-access/">hướng dẫn này</a> để tạo một folder shared cho phép quyền anonymous đọc các file bên trong, yêu cầu máy attacker có kết nối với server sharepoint. Mục đích là để tạo đường dẫn đến file .resources sử dụng cho lớp ResourceSet. Sau đó đưa file .resources đã tạo vào đây, như vậy đường dẫn được tạo có dạng <code class="language-plaintext highlighter-rouge">//DESKTOP-9GA3D02/shared/Resource1.resources</code></p><p>Bước tiếp theo là tạo hai file markup và config cho workflow, phần SetVariableActivity có dạng sau (phần value để giá trị là đường dẫn đến .resources)</p><p><img data-src="/assets/posts/cve-2021-34520/21.png" alt="image" data-proofer-ignore></p><p>Upload hai file lên thư mục workflow của Sharepoint Designer và publish workflow này.</p><p><img data-src="/assets/posts/cve-2021-34520/22.png" alt="Untitled" data-proofer-ignore></p><p>Kết quả sau khi workflow này được chạy là một process Calculator được tạo ra</p><p><img data-src="/assets/posts/cve-2021-34520/23.png" alt="image" data-proofer-ignore></p><h2 id="kết-luận"><span class="mr-2">Kết luận</span><a href="#kết-luận" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Tồn tại một số lớp có gadget chain ẩn chứa bên trong các constructor. Và các constructor được sinh ra đều có lí do, nếu có thể tìm ra các lớp như vậy thì có thể nghiên cứu việc kiểm soát các param của constructor và tìm kiếm cơ hội RCE xung quanh các lớp này.</p><h2 id="references"><span class="mr-2">REFERENCES</span><a href="#references" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>https://www.zerodayinitiative.com/advisories/ZDI-21-828/</p><p>https://support.microsoft.com/en-us/office/introduction-to-sharepoint-workflow-07982276-54e8-4e17-8699-5056eff4d9e3</p><p>https://www.youtube.com/watch?v=JQYrqwgpAFY</p><p>https://blog.virtosoftware.com/how-to-create-sharepoint-designer-2013-workflow/</p><p>https://www.zerodayinitiative.com/blog/2020/4/28/cve-2020-0932-remote-code-execution-on-microsoft-sharepoint-using-typeconverters</p><p>http://nikolar.com/2015/03/10/creating-network-share-with-anonymous-access/</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/one-day-analysis/'>One-day analysis</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/cve-2021-34520/" class="post-tag no-text-decoration" >cve-2021-34520</a> <a href="/tags/microsoft-sharepoint/" class="post-tag no-text-decoration" >microsoft sharepoint</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=CVE-2021-34520 Microsoft Sharepoint RCE - HoangND&amp;url=https://hnd3884.github.io/posts/cve-2021-34520-microsoft-sharepoint-RCE/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=CVE-2021-34520 Microsoft Sharepoint RCE - HoangND&amp;u=https://hnd3884.github.io/posts/cve-2021-34520-microsoft-sharepoint-RCE/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://hnd3884.github.io/posts/cve-2021-34520-microsoft-sharepoint-RCE/&amp;text=CVE-2021-34520 Microsoft Sharepoint RCE - HoangND" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/UMassCTF-2022/">UMassCTF 2022</a><li><a href="/posts/cve-2022-22005-microsoft-sharepoint-RCE/">CVE-2022-22005 Microsoft Sharepoint RCE</a><li><a href="/posts/htb-under-construction/">HTB Under Construction</a><li><a href="/posts/cve-2021-34520-microsoft-sharepoint-RCE/">CVE-2021-34520 Microsoft Sharepoint RCE</a><li><a href="/posts/CVE-2021-42321-Microsoft-Exchange-RCE/">CVE-2021-42321 Microsoft Exchange RCE</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/web/">web</a> <a class="post-tag" href="/tags/sqli/">sqli</a> <a class="post-tag" href="/tags/microsoft-sharepoint/">microsoft sharepoint</a> <a class="post-tag" href="/tags/brute-force/">brute force</a> <a class="post-tag" href="/tags/cve-2021-34520/">cve-2021-34520</a> <a class="post-tag" href="/tags/cve-2021-42321/">cve-2021-42321</a> <a class="post-tag" href="/tags/cve-2022-22005/">cve-2022-22005</a> <a class="post-tag" href="/tags/dom-xss/">dom xss</a> <a class="post-tag" href="/tags/ghost-script/">ghost script</a> <a class="post-tag" href="/tags/graphql/">graphql</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/cve-2022-22005-microsoft-sharepoint-RCE/"><div class="card-body"> <em class="timeago small" data-ts="1646622000" > 2022-03-07 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>CVE-2022-22005 Microsoft Sharepoint RCE</h3><div class="text-muted small"><p> Vulnerability Analysis CVE-2022-22005 Microsoft Sharepoint SharePoint is a platform for sharing and managing content, knowledge, and apps to support teamwork, quickly finding information, and co...</p></div></div></a></div><div class="card"> <a href="/posts/CVE-2021-42321-Microsoft-Exchange-RCE/"><div class="card-body"> <em class="timeago small" data-ts="1637395200" > 2021-11-20 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>CVE-2021-42321 Microsoft Exchange RCE</h3><div class="text-muted small"><p> Ở bản vá tháng 11 của Exchange, một lỗ hổng có mã CVE-2021-42321 được Microsoft tức tốc cảnh báo người dùng phải nhanh chóng cập nhật bản vá để tránh bị khai thác. Bài PoC chi tiết về quá trình di...</p></div></div></a></div><div class="card"> <a href="/posts/UMassCTF-2022/"><div class="card-body"> <em class="timeago small" data-ts="1648918800" > 2022-04-03 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>UMassCTF 2022</h3><div class="text-muted small"><p> I haven’t released any CTF writeups for a long time. Today i done 2 web challenge in UmassCTF so i decided writing something. Venting After tried web features, the proxy history showed me 1 int...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <span class="btn btn-outline-primary disabled" prompt="Older"><p>-</p></span> <a href="/posts/htb-petpet-rcbee/" class="btn btn-outline-primary" prompt="Newer"><p>HTB Petpet Rcbee</p></a></div><script type="text/javascript"> $(function () { const origin = "https://giscus.app"; const iframe = "iframe.giscus-frame"; const lightTheme = "light"; const darkTheme = "dark_dimmed"; let initTheme = lightTheme; if ($("html[data-mode=dark]").length > 0 || ($("html[data-mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches)) { initTheme = darkTheme; } let giscusAttributes = { "src": "https://giscus.app/client.js", "data-repo": "hnd3884/hnd3884.github.io", "data-repo-id": "MDEwOlJlcG9zaXRvcnk0MDMwNzU4NDU=", "data-category": "Announcements", "data-category-id": "DIC_kwDOGAZzBc4CBUan", "data-mapping": "pathname", "data-reactions-enabled": "1", "data-emit-metadata": "0", "data-theme": initTheme, "data-input-position": "top", "data-lang": "en", "crossorigin": "anonymous", "async": "" }; let giscusScript = document.createElement("script"); Object.entries(giscusAttributes).forEach(([key, value]) => giscusScript.setAttribute(key, value)); document.getElementById("tail-wrapper").appendChild(giscusScript); addEventListener("message", (event) => { if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { /* global theme mode changed */ const mode = event.data.message; const theme = (mode === ModeToggle.DARK_MODE ? darkTheme : lightTheme); const message = { setConfig: { theme: theme } }; const giscus = document.querySelector(iframe).contentWindow; giscus.postMessage({ giscus: message }, origin); } }); }); </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/svcrps38">Dinh Hoang</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/web/">web</a> <a class="post-tag" href="/tags/sqli/">sqli</a> <a class="post-tag" href="/tags/microsoft-sharepoint/">microsoft sharepoint</a> <a class="post-tag" href="/tags/brute-force/">brute force</a> <a class="post-tag" href="/tags/cve-2021-34520/">cve-2021-34520</a> <a class="post-tag" href="/tags/cve-2021-42321/">cve-2021-42321</a> <a class="post-tag" href="/tags/cve-2022-22005/">cve-2022-22005</a> <a class="post-tag" href="/tags/dom-xss/">dom xss</a> <a class="post-tag" href="/tags/ghost-script/">ghost script</a> <a class="post-tag" href="/tags/graphql/">graphql</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-PQ5K8VK6JD"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-PQ5K8VK6JD'); }); </script>
