<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="CVE-2022-22005 Microsoft Sharepoint RCE" /><meta name="author" content="HoangND" /><meta property="og:locale" content="en" /><meta name="description" content="Vulnerability Analysis CVE-2022-22005" /><meta property="og:description" content="Vulnerability Analysis CVE-2022-22005" /><link rel="canonical" href="https://hnd3884.github.io/posts/cve-2022-22005-microsoft-sharepoint-RCE/" /><meta property="og:url" content="https://hnd3884.github.io/posts/cve-2022-22005-microsoft-sharepoint-RCE/" /><meta property="og:site_name" content="HoangND" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-03-07T10:00:00+07:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="CVE-2022-22005 Microsoft Sharepoint RCE" /><meta name="twitter:site" content="@svcrps38" /><meta name="twitter:creator" content="@HoangND" /><meta name="google-site-verification" content="TfvZ9qjq-FON4dsURjq-_zTPDu1wLUj3bMCMmf-atHU" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"HoangND"},"dateModified":"2022-03-07T21:59:58+07:00","datePublished":"2022-03-07T10:00:00+07:00","description":"Vulnerability Analysis CVE-2022-22005","headline":"CVE-2022-22005 Microsoft Sharepoint RCE","mainEntityOfPage":{"@type":"WebPage","@id":"https://hnd3884.github.io/posts/cve-2022-22005-microsoft-sharepoint-RCE/"},"url":"https://hnd3884.github.io/posts/cve-2022-22005-microsoft-sharepoint-RCE/"}</script><title>CVE-2022-22005 Microsoft Sharepoint RCE | HoangND</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="HoangND"><meta name="application-name" content="HoangND"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" /avatar.png " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">HoangND</a></div><div class="site-subtitle font-italic">Intern at Viettel Cyber Security</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/hnd3884" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/svcrps38" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['hoangt2k24','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="https://www.linkedin.com/in/hoang-nguyen-dinh-40b01b155/" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>CVE-2022-22005 Microsoft Sharepoint RCE</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>CVE-2022-22005 Microsoft Sharepoint RCE</h1><div class="post-meta text-muted"><div> By <em> <a href="https://twitter.com/svcrps38">Dinh Hoang</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1646622000" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-03-07 </em> </span> <span> Updated <em class="timeago" data-ts="1646665198" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-03-07 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2013 words"> <em>11 min</em> read</span></div></div></div><div class="post-content"><p>Vulnerability Analysis CVE-2022-22005</p><h1 id="microsoft-sharepoint">Microsoft Sharepoint</h1><p><img data-src="/assets/posts/cve-2022-22005/1.png" alt="image" data-proofer-ignore></p><p>SharePoint is a platform for sharing and managing content, knowledge, and apps to support teamwork, quickly finding information, and collaborating seamlessly across the organization. More than 200,000 organizations and 190 million people use SharePoint for intranets, team sites, and content management. The number above is enough to see that this is always a big target for security researchers looking for vulnerabilities.</p><p>With SharePoint, users can create an intranet (or intranet system) that works like any other website. In addition to a large site for the organization, sharepoint can divide small sub-sites for each group and internal department. Besides, this is a great content sharing management platform with customizable lists. Some types of list are built-in on Sharepoint such as list of images, documents, forms… In addition to the built-in lists, users can install a new list and customize the properties of that list as they want. The powerful toolsets for customizing on Sharepoint are Sharepoint Designer and InfoPath Designer.</p><h1 id="cve-2022-22005">CVE-2022-22005</h1><p>Microsoft’s February - 2022 patch fixes a vulnerability with code CVE-2022-22005. This vulnerability allows an attacker to execute code remotely and is scored 8.8 on the CVSSv3 calculator. Affected versions are listed below</p><ul><li>Microsoft SharePoint Server Subscription Edition<li>Microsoft SharePoint Server 2019<li>Microsoft SharePoint Enterprise Server 2013 Service Pack 1<li>Microsoft SharePoint Enterprise Server 2016</ul><p>The analysis below was performed on Microsoft SharePoint Enterprise Server 2016.</p><h2 id="patch-analysis"><span class="mr-2">Patch analysis</span><a href="#patch-analysis" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Install patch January and February 2022 of Sharepoint 2016, gather Sharepoint dll files and decompile into source. Then add a few post-filter steps to remove unnecessary elements (comments, …). Finally compare the two patches to find where the code is used by developers to patch. A deserialization patch location is found at Microsoft.Office.Server.Internal.Charting.UI.WebControls.ChartPreviewImage.loadChartImage()</p><p><img data-src="/assets/posts/cve-2022-22005/2.png" alt="image" data-proofer-ignore></p><p>The patch uses a binder that limits what types are allowed to deserialize, which is what Microsoft used to do for bugs like this in the past. About the deserialize vulnerability you can learn more at <a href="https://portswigger.net/web-security/deserialization">here</a>.</p><h2 id="trace-code"><span class="mr-2">Trace code</span><a href="#trace-code" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Learn a little bit about chart, this is a webpartpage - component of a page on Sharepoint. So it can be understood that in order for the data to go to the deserialize location, there must be a user account <strong>with permission to create page</strong>. Combining debugging and creating a page that uses the chart, the code is hit when the chart is loading data. Observe the function that causes the vulnerability, the deserialize data located in the buffer variable is set via the FetchBinaryData(sessionKey) function.</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="c1">// Microsoft.Office.Server.Internal.Charting.UI.WebControls.ChartPreviewImage.loadChartImage()</span>
<span class="k">private</span> <span class="n">ChartImageSessionBlock</span> <span class="nf">loadChartImage</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">byte</span><span class="p">[]</span> <span class="n">buffer</span> <span class="p">=</span> <span class="n">CustomSessionState</span><span class="p">.</span><span class="nf">FetchBinaryData</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">sessionKey</span><span class="p">);</span>
    <span class="n">ChartImageSessionBlock</span> <span class="n">result</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
    <span class="k">using</span> <span class="p">(</span>
        <span class="n">MemoryStream</span> <span class="n">memoryStream</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">MemoryStream</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="p">{</span>
        <span class="n">IFormatter</span> <span class="n">formatter</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">BinaryFormatter</span><span class="p">();</span>
        <span class="n">result</span> <span class="p">=</span> <span class="p">(</span><span class="n">ChartImageSessionBlock</span><span class="p">)</span><span class="n">formatter</span><span class="p">.</span><span class="nf">Deserialize</span><span class="p">(</span><span class="n">memoryStream</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>The code relates to session state in Sharepoint. This is a mechanism to store the state of an object in the sharepoint, that state can be a file, an image, … or specifically in this case a serialized ChartImageSessionBlock object. These states will be stored in the database as binary data and mapped to a session key. So to exploit this vulnerability we need to control the binary data in the database, then through the loadChartImage function to deserialize an arbitrary object. By using the Burp Suite tool during debugging we can get a request to trigger vulnerability.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>GET /_layouts/15/Chart/WebUI/Controls/ChartPreviewImage.aspx?sk=5264ebfb259840faa703bdbc976e069b_74929f85360d499d9f1d4f337bf49300&amp;hash=2551012 HTTP/1.1
Host: sharepoint2016:33257
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/98.0.4758.82 Safari/537.36
Referer: http://sharepoint2016:33257/SitePages/testpage.aspx
Cookie: stsSyncAppName=Client; stsSyncIconPath=; WSS_FullScreenMode=false
Connection: Keep-Alive
</pre></table></code></div></div><p>The variable <strong>sk</strong> here is the sessionKey passed into the FetchBinaryData function, it has the form guid1_guid2 where guid1 is the id of the database and guid2 is the id of the ChartImageSessionBlock. To exploit the vulnerability, we will force guid2 to the id of another session state that contains the arbitrary binarydata. The next thing to do is figure out how to put arbitrary binary data into the session state table in the database.</p><p><a href="https://www.zerodayinitiative.com/blog/2021/3/17/cve-2021-27076-a-replay-style-deserialization-attack-against-sharepoint">An article</a> is published on the ZDI site about A previous vulnerability with code CVE-2021-27076 related to session state, using attachment mechanism on infopath form. When starting to create a new item in an infopath list, the item will be registered with a session key of <strong>itemId</strong>. Next, when attaching a file to this new item, that file will be saved as a binary data in the database with the key <strong>attachmentId</strong>.</p><p>Arbitrary binary data is in the attachment file, and <strong>attachmentId</strong> is what we need to get to trigger the vulnerability. The problem is that when creating a new item in the infolist, only <strong>itemId</strong> will be returned in response. Through building the lab, found that the value of <strong>attachmentId</strong> is in the binarydata of the item, so we need to find a way to get <strong>attachmentId</strong> through <strong>itemId</strong>. The ZDI article also showed how to solve this problem, which is to replay <strong>itemId</strong> to FormServerAttachments.aspx, which will take the item’s binarydata and return it as a file.</p><p>Here there are two directions to find the right request to FormServerAttachments.aspx, one is to try the functions, the other is to read the code and craft the request yourself. The first option will be better because it will save time and we will also get a right-format request. In case the function cannot be determined, it is mandatory to follow option 2 to read the code. Because the binary is returned as a file, the FileDownload function caught my eye.</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
</pre><td class="rouge-code"><pre><span class="c1">// Microsoft.Office.InfoPath.Server.Controls.FormServerAttachments.FileDownload(HttpContext) </span>
<span class="k">private</span> <span class="k">static</span> <span class="kt">bool</span> <span class="nf">FileDownload</span><span class="p">(</span><span class="n">HttpContext</span> <span class="n">context</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">string</span> <span class="n">text</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="n">Request</span><span class="p">.</span><span class="n">QueryString</span><span class="p">[</span><span class="s">"fid"</span><span class="p">];</span>
    <span class="kt">string</span> <span class="n">text2</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="n">Request</span><span class="p">.</span><span class="n">QueryString</span><span class="p">[</span><span class="s">"sid"</span><span class="p">];</span>
    <span class="kt">string</span> <span class="k">value</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="n">Request</span><span class="p">.</span><span class="n">QueryString</span><span class="p">[</span><span class="s">"key"</span><span class="p">];</span>
    <span class="kt">string</span> <span class="n">strA</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="n">Request</span><span class="p">.</span><span class="n">QueryString</span><span class="p">[</span><span class="s">"dl"</span><span class="p">];</span>
    <span class="kt">int</span> <span class="n">num</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
    <span class="kt">string</span> <span class="n">empty</span> <span class="p">=</span> <span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="nf">IsNullOrEmpty</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="p">||</span> <span class="kt">string</span><span class="p">.</span><span class="nf">IsNullOrEmpty</span><span class="p">(</span><span class="n">text2</span><span class="p">)</span> <span class="p">||</span> <span class="kt">string</span><span class="p">.</span><span class="nf">IsNullOrEmpty</span><span class="p">(</span><span class="k">value</span><span class="p">)</span> <span class="p">||</span> <span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="nf">Compare</span><span class="p">(</span><span class="n">strA</span><span class="p">,</span> <span class="s">"fa"</span><span class="p">,</span> <span class="n">StringComparison</span><span class="p">.</span><span class="n">OrdinalIgnoreCase</span><span class="p">)</span> <span class="p">!=</span> <span class="m">0</span> <span class="p">&amp;&amp;</span> <span class="kt">string</span><span class="p">.</span><span class="nf">Compare</span><span class="p">(</span><span class="n">strA</span><span class="p">,</span> <span class="s">"ip"</span><span class="p">,</span> <span class="n">StringComparison</span><span class="p">.</span><span class="n">OrdinalIgnoreCase</span><span class="p">)</span> <span class="p">!=</span> <span class="m">0</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">ULS</span><span class="p">.</span><span class="nf">SendTraceTag</span><span class="p">(</span><span class="m">1831874679U</span><span class="p">,</span> <span class="n">ULSCat</span><span class="p">.</span><span class="n">msoulscat_formservices_runtime</span><span class="p">,</span> <span class="n">ULSTraceLevel</span><span class="p">.</span><span class="n">Medium</span><span class="p">,</span> <span class="s">"Invalid request incorrect or missing query strings: {0}"</span><span class="p">,</span> <span class="k">new</span> <span class="kt">object</span><span class="p">[]</span>
        <span class="p">{</span>
                    <span class="n">context</span><span class="p">.</span><span class="n">Request</span><span class="p">.</span><span class="n">Url</span><span class="p">.</span><span class="nf">ToString</span><span class="p">()</span>
        <span class="p">});</span>
        <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">using</span> <span class="p">(</span><span class="k">new</span> <span class="nf">GlobalStorageContext</span><span class="p">(</span><span class="n">text</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="k">try</span>
        <span class="p">{</span>
            <span class="n">SPSite</span> <span class="n">spsite</span> <span class="p">=</span> <span class="n">SiteAndWebCache</span><span class="p">.</span><span class="nf">Fetch</span><span class="p">().</span><span class="nf">EnsureRequestSite</span><span class="p">();</span>
            <span class="n">Solution</span> <span class="n">solutionById</span> <span class="p">=</span> <span class="n">SolutionCache</span><span class="p">.</span><span class="nf">GetSolutionById</span><span class="p">(</span><span class="n">spsite</span><span class="p">,</span> <span class="k">new</span> <span class="nf">SolutionIdentity</span><span class="p">(</span><span class="n">text2</span><span class="p">));</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">Canary</span><span class="p">.</span><span class="nf">VerifyCanaryFromCookie</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">spsite</span><span class="p">,</span> <span class="n">solutionById</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="nf">Clear</span><span class="p">();</span>
                <span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">Cache</span><span class="p">.</span><span class="nf">SetExpires</span><span class="p">(</span><span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">.</span><span class="nf">AddDays</span><span class="p">(</span><span class="m">2.0</span><span class="p">));</span>
                <span class="k">using</span> <span class="p">(</span><span class="n">BinaryWriter</span> <span class="n">binaryWriter</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">BinaryWriter</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">OutputStream</span><span class="p">))</span>
                <span class="p">{</span>
                    <span class="n">Base64DataStorage</span><span class="p">.</span><span class="n">Base64DataItem</span> <span class="n">item</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
                    <span class="n">StreamUtils</span><span class="p">.</span><span class="nf">DeserializeObjectsFromString</span><span class="p">(</span><span class="k">value</span><span class="p">,</span> <span class="k">delegate</span> <span class="p">(</span><span class="n">EnhancedBinaryReader</span> <span class="n">binaryReader</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="n">item</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Base64DataStorage</span><span class="p">.</span><span class="nf">Base64DataItem</span><span class="p">(</span><span class="n">binaryReader</span><span class="p">);</span>
                        <span class="n">DocumentChildState</span><span class="p">.</span><span class="n">StateInfo</span> <span class="n">stateInfo</span> <span class="p">=</span> <span class="k">new</span> <span class="n">DocumentChildState</span><span class="p">.</span><span class="nf">StateInfo</span><span class="p">();</span>
                        <span class="p">((</span><span class="n">IBinaryDeserializable</span><span class="p">)</span><span class="n">stateInfo</span><span class="p">).</span><span class="nf">Deserialize</span><span class="p">(</span><span class="n">binaryReader</span><span class="p">);</span>
                        <span class="n">StateKey</span> <span class="n">stateKey</span> <span class="p">=</span> <span class="n">StateKey</span><span class="p">.</span><span class="nf">ParseKey</span><span class="p">(</span><span class="n">stateInfo</span><span class="p">.</span><span class="n">SerializedKey</span><span class="p">);</span>
                        <span class="n">item</span><span class="p">.</span><span class="nf">EnsureData</span><span class="p">(</span><span class="n">stateKey</span><span class="p">);</span>
                    <span class="p">});</span>
                    <span class="kt">byte</span><span class="p">[]</span> <span class="n">dataAsBytes</span> <span class="p">=</span> <span class="n">item</span><span class="p">.</span><span class="nf">GetDataAsBytes</span><span class="p">();</span>
                    <span class="k">using</span> <span class="p">(</span><span class="n">Stream</span> <span class="n">stream</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">MemoryStream</span><span class="p">(</span><span class="n">dataAsBytes</span><span class="p">,</span> <span class="k">false</span><span class="p">))</span>
                    <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="nf">Compare</span><span class="p">(</span><span class="n">strA</span><span class="p">,</span> <span class="s">"fa"</span><span class="p">,</span> <span class="n">StringComparison</span><span class="p">.</span><span class="n">OrdinalIgnoreCase</span><span class="p">)</span> <span class="p">!=</span> <span class="m">0</span><span class="p">)</span>
                        <span class="p">{</span>
                            <span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="nf">AppendHeader</span><span class="p">(</span><span class="s">"Content-Disposition"</span><span class="p">,</span> <span class="s">"attachment;filename=\"image\""</span><span class="p">);</span>
                            <span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="nf">AppendHeader</span><span class="p">(</span><span class="s">"X-Download-Options"</span><span class="p">,</span> <span class="s">"noopen"</span><span class="p">);</span>
                            <span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">ContentType</span> <span class="p">=</span> <span class="n">ImageUtils</span><span class="p">.</span><span class="nf">GetContentType</span><span class="p">(</span><span class="n">dataAsBytes</span><span class="p">);</span>
                            <span class="k">return</span> <span class="n">InlinePicture</span><span class="p">.</span><span class="nf">ReadInfoFromStream</span><span class="p">(</span><span class="n">binaryWriter</span><span class="p">,</span> <span class="n">stream</span><span class="p">);</span>
                        <span class="p">}</span>
                        <span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">ContentType</span> <span class="p">=</span> <span class="s">"application/octet-stream"</span><span class="p">;</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">FileAttachment</span><span class="p">.</span><span class="nf">ReadInfoFromStream</span><span class="p">(</span><span class="n">binaryWriter</span><span class="p">,</span> <span class="k">out</span> <span class="n">num</span><span class="p">,</span> <span class="k">out</span> <span class="n">empty</span><span class="p">,</span> <span class="n">stream</span><span class="p">))</span>
                        <span class="p">{</span>
                            <span class="n">FilePathUtils</span><span class="p">.</span><span class="nf">AddFileDownloadHttpHeader</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">empty</span><span class="p">);</span>
                            <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
                        <span class="p">}</span>
                        <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="n">ULS</span><span class="p">.</span><span class="nf">SendTraceTag</span><span class="p">(</span><span class="m">1831874680U</span><span class="p">,</span> <span class="n">ULSCat</span><span class="p">.</span><span class="n">msoulscat_formservices_runtime</span><span class="p">,</span> <span class="n">ULSTraceLevel</span><span class="p">.</span><span class="n">Verbose</span><span class="p">,</span> <span class="s">"Can't verify canary from cookie for FileDownload"</span><span class="p">);</span>
            <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">catch</span> <span class="p">(</span><span class="n">InfoPathException</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">ULS</span><span class="p">.</span><span class="nf">SendTraceTag</span><span class="p">(</span><span class="m">1831874681U</span><span class="p">,</span> <span class="n">ULSCat</span><span class="p">.</span><span class="n">msoulscat_formservices_runtime</span><span class="p">,</span> <span class="n">ULSTraceLevel</span><span class="p">.</span><span class="n">Medium</span><span class="p">,</span> <span class="s">"InfoPathException occurred downloading fileattachment or inline picture"</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Luckily the variables required for request are pretty obvious - <strong>fid</strong>, <strong>sid</strong>, <strong>key</strong>, <strong>dl</strong>. Let’s dive a little deeper into the components, the following code is the error return condition</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="c1">// fid -&gt; text, sid -&gt; text2, key -&gt; value, dl -&gt; strA</span>
<span class="k">if</span> <span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="nf">IsNullOrEmpty</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="p">||</span> <span class="kt">string</span><span class="p">.</span><span class="nf">IsNullOrEmpty</span><span class="p">(</span><span class="n">text2</span><span class="p">)</span> <span class="p">||</span> <span class="kt">string</span><span class="p">.</span><span class="nf">IsNullOrEmpty</span><span class="p">(</span><span class="k">value</span><span class="p">)</span> <span class="p">||</span> <span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="nf">Compare</span><span class="p">(</span><span class="n">strA</span><span class="p">,</span> <span class="s">"fa"</span><span class="p">,</span> <span class="n">StringComparison</span><span class="p">.</span><span class="n">OrdinalIgnoreCase</span><span class="p">)</span> <span class="p">!=</span> <span class="m">0</span> <span class="p">&amp;&amp;</span> <span class="kt">string</span><span class="p">.</span><span class="nf">Compare</span><span class="p">(</span><span class="n">strA</span><span class="p">,</span> <span class="s">"ip"</span><span class="p">,</span> <span class="n">StringComparison</span><span class="p">.</span><span class="n">OrdinalIgnoreCase</span><span class="p">)</span> <span class="p">!=</span> <span class="m">0</span><span class="p">))</span>
</pre></table></code></div></div><p>So the required params must be non-empty, where <strong>dl</strong> must be either the string ‘fa’ or ‘ip’.</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="c1">// fid -&gt; text, sid -&gt; text2, key -&gt; value, dl -&gt; strA</span>
<span class="n">SPSite</span> <span class="n">spsite</span> <span class="p">=</span> <span class="n">SiteAndWebCache</span><span class="p">.</span><span class="nf">Fetch</span><span class="p">().</span><span class="nf">EnsureRequestSite</span><span class="p">();</span>
<span class="n">Solution</span> <span class="n">solutionById</span> <span class="p">=</span> <span class="n">SolutionCache</span><span class="p">.</span><span class="nf">GetSolutionById</span><span class="p">(</span><span class="n">spsite</span><span class="p">,</span> <span class="k">new</span> <span class="nf">SolutionIdentity</span><span class="p">(</span><span class="n">text2</span><span class="p">));</span>
<span class="k">if</span> <span class="p">(</span><span class="n">Canary</span><span class="p">.</span><span class="nf">VerifyCanaryFromCookie</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">spsite</span><span class="p">,</span> <span class="n">solutionById</span><span class="p">))</span>
<span class="p">{</span>
    <span class="p">...</span>
<span class="p">}</span>
</pre></table></code></div></div><p>This code gets the solutionId from <strong>sid</strong> and authenticate it with the infopath canary inside the cookie, for example a cookie like this:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>_InfoPath_CanaryValueAGQX2G3RUCCXQRUNZHR3UB7IIEMSOL2MNFZXI4ZPORSXG5C7NFXGM327NRUXG5BPJF2GK3JPORSW24DMMF2GKLTYONXCWMKZLBZTE4TDI5WXC4ZSIIZGIUTINE4EI6DBGFWVKNKDLFZGSTJYLFNHE33VMJ5EGSLEOM=KBxeU4WXMZ3Yg8v0ZPZfAWcpoiLL/R3sfejthMFTfL1x9GqMoiIOMSS9XrT0gguJmdn0Yj2qw0gqlDJXT7X49A==|637806206864107501
</pre></table></code></div></div><p>This cookie has a key in the format ‘_InfoPath_CanaryValue’+ suffix. The suffix is <strong>sid</strong> to look for. Next is the code that gets the binary data from the session key.</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="c1">// fid -&gt; text, sid -&gt; text2, key -&gt; value, dl -&gt; strA</span>
<span class="n">Base64DataStorage</span><span class="p">.</span><span class="n">Base64DataItem</span> <span class="n">item</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
<span class="n">StreamUtils</span><span class="p">.</span><span class="nf">DeserializeObjectsFromString</span><span class="p">(</span><span class="k">value</span><span class="p">,</span> <span class="k">delegate</span> <span class="p">(</span><span class="n">EnhancedBinaryReader</span> <span class="n">binaryReader</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">item</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Base64DataStorage</span><span class="p">.</span><span class="nf">Base64DataItem</span><span class="p">(</span><span class="n">binaryReader</span><span class="p">);</span>
    <span class="n">DocumentChildState</span><span class="p">.</span><span class="n">StateInfo</span> <span class="n">stateInfo</span> <span class="p">=</span> <span class="k">new</span> <span class="n">DocumentChildState</span><span class="p">.</span><span class="nf">StateInfo</span><span class="p">();</span>
    <span class="p">((</span><span class="n">IBinaryDeserializable</span><span class="p">)</span><span class="n">stateInfo</span><span class="p">).</span><span class="nf">Deserialize</span><span class="p">(</span><span class="n">binaryReader</span><span class="p">);</span>
    <span class="n">StateKey</span> <span class="n">stateKey</span> <span class="p">=</span> <span class="n">StateKey</span><span class="p">.</span><span class="nf">ParseKey</span><span class="p">(</span><span class="n">stateInfo</span><span class="p">.</span><span class="n">SerializedKey</span><span class="p">);</span>
    <span class="n">item</span><span class="p">.</span><span class="nf">EnsureData</span><span class="p">(</span><span class="n">stateKey</span><span class="p">);</span>
<span class="p">});</span>
<span class="kt">byte</span><span class="p">[]</span> <span class="n">dataAsBytes</span> <span class="p">=</span> <span class="n">item</span><span class="p">.</span><span class="nf">GetDataAsBytes</span><span class="p">();</span>
</pre></table></code></div></div><p>The session state key will be retrieved from the <strong>key</strong> variable, let’s see the details of the DeserializeObjectsFromString function</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="c1">// fid -&gt; text, sid -&gt; text2, key -&gt; value, dl -&gt; strA</span>
<span class="k">internal</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">DeserializeObjectsFromString</span><span class="p">(</span><span class="kt">string</span> <span class="k">value</span><span class="p">,</span> <span class="n">Action</span><span class="p">&lt;</span><span class="n">EnhancedBinaryReader</span><span class="p">&gt;</span> <span class="n">readerMethod</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">using</span> <span class="p">(</span><span class="n">Base64Stream</span> <span class="n">base64Stream</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Base64Stream</span><span class="p">(</span><span class="k">value</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="k">using</span> <span class="p">(</span><span class="n">EnhancedBinaryReader</span> <span class="n">enhancedBinaryReader</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">EnhancedBinaryReader</span><span class="p">(</span><span class="n">base64Stream</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="nf">readerMethod</span><span class="p">(</span><span class="n">enhancedBinaryReader</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>So <strong>key</strong> needs to be in base64 format, see Base64DataStorage.Base64DataItem(binaryReader) function.</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="c1">// Microsoft.Office.InfoPath.Server.SolutionLifetime.Base64DataStorage.Base64DataItem.Base64DataItem(EnhancedBinaryReader)</span>
<span class="k">internal</span> <span class="nf">Base64DataItem</span><span class="p">(</span><span class="n">EnhancedBinaryReader</span> <span class="n">reader</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="n">_state</span> <span class="p">=</span> <span class="p">(</span><span class="n">Base64ItemState</span><span class="p">)</span><span class="n">reader</span><span class="p">.</span><span class="nf">ReadCompressedInt</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="n">_sessionDataType</span> <span class="p">=</span> <span class="p">(</span><span class="n">Base64DataStorage</span><span class="p">.</span><span class="n">Base64DataItem</span><span class="p">.</span><span class="n">DataTypeInSessionState</span><span class="p">)</span><span class="n">reader</span><span class="p">.</span><span class="nf">ReadCompressedInt</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="n">_itemId</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Base64SerializationId</span><span class="p">(</span><span class="n">reader</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>So the first 3 positions in the <strong>key</strong>’s structure will be</p><ul><li>base64ItemState (int)<li>dataTypeInSessionState (int)<li>base64SerializationId (guid string)</ul><p>let’s see the function DocumentChildState.StateInfo.Deserialize(binaryReader)</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="c1">// DocumentChildState.StateInfo.Deserialize(binaryReader)</span>
<span class="k">void</span> <span class="n">IBinaryDeserializable</span><span class="p">.</span><span class="nf">Deserialize</span><span class="p">(</span><span class="n">EnhancedBinaryReader</span> <span class="n">reader</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="n">_serializedKey</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="nf">ReadString</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="n">_size</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="nf">ReadCompressedInt</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="n">_version</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="nf">ReadCompressedInt</span><span class="p">();</span>
<span class="p">}</span>
</pre></table></code></div></div><p>so the next 3 positions in the <strong>key</strong>’s structure will be</p><ul><li>serializedKey (string)<li>size (int)<li>version (int)</ul><p>Next let’s consider which components will require correct value. The part to get the session state key is as follows</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">StateKey</span> <span class="n">stateKey</span> <span class="p">=</span> <span class="n">StateKey</span><span class="p">.</span><span class="nf">ParseKey</span><span class="p">(</span><span class="n">stateInfo</span><span class="p">.</span><span class="n">SerializedKey</span><span class="p">);</span>
<span class="n">item</span><span class="p">.</span><span class="nf">EnsureData</span><span class="p">(</span><span class="n">stateKey</span><span class="p">);</span>
</pre></table></code></div></div><p>So the serializedKey has the form guid1_guid2, where guid1 is the database id and guid2 is the <strong>itemId</strong> we put in, next see the item.EnsureData(stateKey) function</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="c1">// Microsoft.Office.InfoPath.Server.SolutionLifetime.Base64DataStorage.Base64DataItem.EnsureData(StateKey)</span>
<span class="k">internal</span> <span class="k">void</span> <span class="nf">EnsureData</span><span class="p">(</span><span class="n">StateKey</span> <span class="n">stateKey</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">State</span> <span class="p">==</span> <span class="n">Base64ItemState</span><span class="p">.</span><span class="n">DelayLoad</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">byte</span><span class="p">[]</span> <span class="n">sessionData</span> <span class="p">=</span> <span class="n">StateManager</span><span class="p">.</span><span class="nf">GetManager</span><span class="p">(</span><span class="n">HttpContext</span><span class="p">.</span><span class="n">Current</span><span class="p">).</span><span class="nf">PeekState</span><span class="p">(</span><span class="n">stateKey</span><span class="p">);</span> <span class="c1">// get binary data from stateKey</span>
        <span class="k">this</span><span class="p">.</span><span class="nf">SetSessionData</span><span class="p">(</span><span class="n">sessionData</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">State</span> <span class="p">==</span> <span class="n">Base64ItemState</span><span class="p">.</span><span class="n">Removed</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">InfoPathLocalizedException</span><span class="p">(</span><span class="n">InfoPathResourceManager</span><span class="p">.</span><span class="n">Ids</span><span class="p">.</span><span class="n">ServerGenericError</span><span class="p">,</span> <span class="k">new</span> <span class="kt">string</span><span class="p">[</span><span class="m">0</span><span class="p">]);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>The first condition must be met to get binarydata from the database, so base64ItemState must have the value of enum Base64ItemState.DelayLoad, see inside Base64ItemState</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="k">internal</span> <span class="k">enum</span> <span class="n">Base64ItemState</span>
<span class="p">{</span>
    <span class="n">NoChange</span><span class="p">,</span>
    <span class="n">Updated</span><span class="p">,</span>
    <span class="n">Removed</span><span class="p">,</span>
    <span class="n">New</span><span class="p">,</span>
    <span class="n">DelayLoad</span> <span class="c1">// 4</span>
<span class="p">}</span>
</pre></table></code></div></div><p>From there base64ItemState has to be 4. Next look at the enum values of dataTypeInSessionState</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="k">private</span> <span class="k">enum</span> <span class="n">DataTypeInSessionState</span>
<span class="p">{</span>
    <span class="n">Unknown</span><span class="p">,</span>
    <span class="n">Utf8String</span><span class="p">,</span>
    <span class="n">ByteArray</span>  <span class="c1">// 2</span>
<span class="p">}</span>
</pre></table></code></div></div><p>The data we need is stored in the session state table as binary data, so the value of dataTypeInSessionState has to be 2. In summary, <strong>key</strong> has the following structure.</p><p><img data-src="/assets/posts/cve-2022-22005/3.png" alt="image" data-proofer-ignore></p><p>After getting the binarydata, here is the code returns it as a file</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="k">using</span> <span class="p">(</span><span class="n">Stream</span> <span class="n">stream</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">MemoryStream</span><span class="p">(</span><span class="n">dataAsBytes</span><span class="p">,</span> <span class="k">false</span><span class="p">))</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="nf">Compare</span><span class="p">(</span><span class="n">strA</span><span class="p">,</span> <span class="s">"fa"</span><span class="p">,</span> <span class="n">StringComparison</span><span class="p">.</span><span class="n">OrdinalIgnoreCase</span><span class="p">)</span> <span class="p">!=</span> <span class="m">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="nf">AppendHeader</span><span class="p">(</span><span class="s">"Content-Disposition"</span><span class="p">,</span> <span class="s">"attachment;filename=\"image\""</span><span class="p">);</span>
        <span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="nf">AppendHeader</span><span class="p">(</span><span class="s">"X-Download-Options"</span><span class="p">,</span> <span class="s">"noopen"</span><span class="p">);</span>
        <span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">ContentType</span> <span class="p">=</span> <span class="n">ImageUtils</span><span class="p">.</span><span class="nf">GetContentType</span><span class="p">(</span><span class="n">dataAsBytes</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">InlinePicture</span><span class="p">.</span><span class="nf">ReadInfoFromStream</span><span class="p">(</span><span class="n">binaryWriter</span><span class="p">,</span> <span class="n">stream</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">ContentType</span> <span class="p">=</span> <span class="s">"application/octet-stream"</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">FileAttachment</span><span class="p">.</span><span class="nf">ReadInfoFromStream</span><span class="p">(</span><span class="n">binaryWriter</span><span class="p">,</span> <span class="k">out</span> <span class="n">num</span><span class="p">,</span> <span class="k">out</span> <span class="n">empty</span><span class="p">,</span> <span class="n">stream</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">FilePathUtils</span><span class="p">.</span><span class="nf">AddFileDownloadHttpHeader</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">empty</span><span class="p">);</span>
        <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>so <strong>dl</strong> must have the value ‘ip’. The variables sent to FormServerAttachments.aspx have the following form</p><p><img data-src="/assets/posts/cve-2022-22005/4.png" alt="image" data-proofer-ignore></p><h2 id="exploit-steps"><span class="mr-2">Exploit steps</span><a href="#exploit-steps" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>After detailed analysis, the exploit steps are summarized as follows:</p><ol><li>Create an infopath list on the site.<li>Open the form to create a new item on the list, save the <strong>itemId</strong> from the response.<li>Attachment file contains the payload on that item, but don’t press save so that the session state can be kept in the database.<li>Put the <strong>itemId</strong> information obtained from step 2 into the request sent to FormServerAttachments.aspx, save the <strong>attachmentId</strong> information from the response.<li>Include <strong>attachmentId</strong> in the request to trigger deserialize in ChartPreviewImage.</ol><h2 id="permission"><span class="mr-2">Permission</span><a href="#permission" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>By default, a normal account has permission to create sub-sites and that account will have full permissions on the new site. Therefore, we only need an account with default permissions to exploit the vulnerability.</p><h2 id="proof-of-concept"><span class="mr-2">Proof of Concept</span><a href="#proof-of-concept" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p><a href="https://youtu.be/1Ckjh-uuNu4">https://youtu.be/1Ckjh-uuNu4</a></p><h1 id="references">REFERENCES</h1><p><a href="https://www.zerodayinitiative.com/blog/2021/3/17/cve-2021-27076-a-replay-style-deserialization-attack-against-sharepoint">https://www.zerodayinitiative.com/blog/2021/3/17/cve-2021-27076-a-replay-style-deserialization-attack-against-sharepoint</a></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/one-day-analysis/'>One-day analysis</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/cve-2022-22005/" class="post-tag no-text-decoration" >cve-2022-22005</a> <a href="/tags/microsoft-sharepoint/" class="post-tag no-text-decoration" >microsoft sharepoint</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=CVE-2022-22005 Microsoft Sharepoint RCE - HoangND&amp;url=https://hnd3884.github.io/posts/cve-2022-22005-microsoft-sharepoint-RCE/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=CVE-2022-22005 Microsoft Sharepoint RCE - HoangND&amp;u=https://hnd3884.github.io/posts/cve-2022-22005-microsoft-sharepoint-RCE/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://hnd3884.github.io/posts/cve-2022-22005-microsoft-sharepoint-RCE/&amp;text=CVE-2022-22005 Microsoft Sharepoint RCE - HoangND" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/UMassCTF-2022/">UMassCTF 2022</a><li><a href="/posts/cve-2022-22005-microsoft-sharepoint-RCE/">CVE-2022-22005 Microsoft Sharepoint RCE</a><li><a href="/posts/htb-under-construction/">HTB Under Construction</a><li><a href="/posts/cve-2021-34520-microsoft-sharepoint-RCE/">CVE-2021-34520 Microsoft Sharepoint RCE</a><li><a href="/posts/CVE-2021-42321-Microsoft-Exchange-RCE/">CVE-2021-42321 Microsoft Exchange RCE</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/web/">web</a> <a class="post-tag" href="/tags/sqli/">sqli</a> <a class="post-tag" href="/tags/microsoft-sharepoint/">microsoft sharepoint</a> <a class="post-tag" href="/tags/brute-force/">brute force</a> <a class="post-tag" href="/tags/cve-2021-34520/">cve-2021-34520</a> <a class="post-tag" href="/tags/cve-2021-42321/">cve-2021-42321</a> <a class="post-tag" href="/tags/cve-2022-22005/">cve-2022-22005</a> <a class="post-tag" href="/tags/dom-xss/">dom xss</a> <a class="post-tag" href="/tags/ghost-script/">ghost script</a> <a class="post-tag" href="/tags/graphql/">graphql</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/cve-2021-34520-microsoft-sharepoint-RCE/"><div class="card-body"> <em class="timeago small" data-ts="1630726560" > 2021-09-04 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>CVE-2021-34520 Microsoft Sharepoint RCE</h3><div class="text-muted small"><p> Phân tích lỗi CVE-2021-34520 Sharepoint Workflow Chúng ta có thể phân tách nghĩa của từ Workflow là làm 2 phần bao gồm “Work” nghĩa là công việc, “flow” nghĩa là dòng chảy. Flow đi chung với Work ...</p></div></div></a></div><div class="card"> <a href="/posts/CVE-2021-42321-Microsoft-Exchange-RCE/"><div class="card-body"> <em class="timeago small" data-ts="1637395200" > 2021-11-20 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>CVE-2021-42321 Microsoft Exchange RCE</h3><div class="text-muted small"><p> Ở bản vá tháng 11 của Exchange, một lỗ hổng có mã CVE-2021-42321 được Microsoft tức tốc cảnh báo người dùng phải nhanh chóng cập nhật bản vá để tránh bị khai thác. Bài PoC chi tiết về quá trình di...</p></div></div></a></div><div class="card"> <a href="/posts/UMassCTF-2022/"><div class="card-body"> <em class="timeago small" data-ts="1648918800" > 2022-04-03 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>UMassCTF 2022</h3><div class="text-muted small"><p> I haven’t released any CTF writeups for a long time. Today i done 2 web challenge in UmassCTF so i decided writing something. Venting After tried web features, the proxy history showed me 1 int...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/CVE-2021-42321-Microsoft-Exchange-RCE/" class="btn btn-outline-primary" prompt="Older"><p>CVE-2021-42321 Microsoft Exchange RCE</p></a> <a href="/posts/UMassCTF-2022/" class="btn btn-outline-primary" prompt="Newer"><p>UMassCTF 2022</p></a></div><script type="text/javascript"> $(function () { const origin = "https://giscus.app"; const iframe = "iframe.giscus-frame"; const lightTheme = "light"; const darkTheme = "dark_dimmed"; let initTheme = lightTheme; if ($("html[data-mode=dark]").length > 0 || ($("html[data-mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches)) { initTheme = darkTheme; } let giscusAttributes = { "src": "https://giscus.app/client.js", "data-repo": "hnd3884/hnd3884.github.io", "data-repo-id": "MDEwOlJlcG9zaXRvcnk0MDMwNzU4NDU=", "data-category": "Announcements", "data-category-id": "DIC_kwDOGAZzBc4CBUan", "data-mapping": "pathname", "data-reactions-enabled": "1", "data-emit-metadata": "0", "data-theme": initTheme, "data-input-position": "top", "data-lang": "en", "crossorigin": "anonymous", "async": "" }; let giscusScript = document.createElement("script"); Object.entries(giscusAttributes).forEach(([key, value]) => giscusScript.setAttribute(key, value)); document.getElementById("tail-wrapper").appendChild(giscusScript); addEventListener("message", (event) => { if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { /* global theme mode changed */ const mode = event.data.message; const theme = (mode === ModeToggle.DARK_MODE ? darkTheme : lightTheme); const message = { setConfig: { theme: theme } }; const giscus = document.querySelector(iframe).contentWindow; giscus.postMessage({ giscus: message }, origin); } }); }); </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/svcrps38">Dinh Hoang</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/web/">web</a> <a class="post-tag" href="/tags/sqli/">sqli</a> <a class="post-tag" href="/tags/microsoft-sharepoint/">microsoft sharepoint</a> <a class="post-tag" href="/tags/brute-force/">brute force</a> <a class="post-tag" href="/tags/cve-2021-34520/">cve-2021-34520</a> <a class="post-tag" href="/tags/cve-2021-42321/">cve-2021-42321</a> <a class="post-tag" href="/tags/cve-2022-22005/">cve-2022-22005</a> <a class="post-tag" href="/tags/dom-xss/">dom xss</a> <a class="post-tag" href="/tags/ghost-script/">ghost script</a> <a class="post-tag" href="/tags/graphql/">graphql</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-PQ5K8VK6JD"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-PQ5K8VK6JD'); }); </script>
